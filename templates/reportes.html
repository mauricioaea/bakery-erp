<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Panader√≠a </title>
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        /* Header */
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            text-align: center;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s ease;
        }
        
        /* Report Grid */
        .reporte-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .reporte-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .reporte-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .reporte-card.contable {
            border-left-color: #e74c3c;
        }
        .reporte-card.gerencial {
            border-left-color: #27ae60;
        }
        .reporte-card.unificado {
            border-left-color: #9b59b6;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
            border: 2px solid #9b59b6;
        }
        .reporte-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .reporte-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        /* Botones */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9em;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        .btn-purple {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        /* Flash Messages */
        .flash-messages {
            margin-bottom: 20px;
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Date Grid */
        .date-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }
        .bg-success { background: #27ae60; color: white; }
        .bg-info { background: #3498db; color: white; }
        .bg-warning { background: #f39c12; color: white; }
        .bg-purple { background: #9b59b6; color: white; }
        .bg-danger { background: #e74c3c; color: white; }
        .bg-secondary { background: #6c757d; color: white; }
        
        /* Select Styles */
        select.form-control {
            background: white;
            cursor: pointer;
        }
        
        /* Tabla de dep√≥sitos */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .depositos-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        .depositos-table th {
            background: #34495e;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
        }
        .depositos-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .depositos-table tr:hover {
            background: #f8f9fa;
        }
        .estado-registrado {
            color: #f39c12;
            font-weight: bold;
        }
        .estado-conciliado {
            color: #27ae60;
            font-weight: bold;
        }
        .estado-anulado {
            color: #e74c3c;
            font-weight: bold;
        }
        .acciones-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* Filtros */
        .filtros-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .filtro-group {
            display: flex;
            flex-direction: column;
        }
        .filtro-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        /* Estad√≠sticas */
        .estadisticas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .estadistica-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .estadistica-valor {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .estadistica-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h3 {
            color: #2c3e50;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
        }
        .close-modal:hover {
            color: #e74c3c;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-full-width {
            grid-column: 1 / -1;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .date-grid,
            .form-grid {
                grid-template-columns: 1fr;
            }
            .reporte-grid {
                grid-template-columns: 1fr;
            }
            .filtros-container {
                grid-template-columns: 1fr;
            }
            .modal-content {
                margin: 20px auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mensajes Flash -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Header -->
        <div class="header">
            <h1>üìä Sistema de Reportes Profesionales</h1>
            <p class="subtitle">Reportes contables y gerenciales para toma de decisiones</p>
            
            <div class="nav-buttons">
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">üè† Volver al Dashboard</a>
                <a href="{{ url_for('control_diario') }}" class="btn btn-warning">üí∞ Gesti√≥n Financiera</a>
            </div>
        </div>

        <!-- Selector de Fechas -->
        <div class="card">
            <h2>üìÖ Seleccionar Per√≠odo del Reporte</h2>
            <form id="formFechas">
                <div class="date-grid">
                    <div class="form-group">
                        <label>Fecha de Inicio:</label>
                        <input type="date" id="fecha_inicio" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Fin:</label>
                        <input type="date" id="fecha_fin" class="form-control" required>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button type="button" class="btn btn-primary" onclick="establecerPeriodo('semana')">√öltima Semana</button>
                    <button type="button" class="btn btn-primary" onclick="establecerPeriodo('mes')">√öltimo Mes</button>
                    <button type="button" class="btn btn-primary" onclick="establecerPeriodo('trimestre')">√öltimo Trimestre</button>
                </div>
            </form>
        </div>

        <!-- Reporte Unificado de Tesorer√≠a -->
        <div class="card">
            <h2>REPORTE UNIFICADO DE TESORER√çA</h2>
            <p><strong>Consolidaci√≥n Integral de Estados Financieros</strong><br/>
            Documento unificado que integra el Libro Mayor con el Estado de Flujos de Efectivo para an√°lisis financiero completo.</p>
            
            <div class="reporte-grid">
                <div class="reporte-card unificado">
                    <h3>Reporte Consolidado de Tesorer√≠a</h3>
                    <p><strong>Integraci√≥n de Estados Financieros</strong><br/>
                    Combina el detalle transaccional del Libro Mayor con el an√°lisis de flujos del Estado de Efectivo, proporcionando una visi√≥n integral de la posici√≥n de liquidez y gesti√≥n de tesorer√≠a.</p>
                    
                    <div class="form-group">
                        <label for="nivel_detalle_tesoreria"><strong>Nivel de Detalle:</strong></label>
                        <select id="nivel_detalle_tesoreria" class="form-control">
                            <option value="resumen">Resumen Ejecutivo</option>
                            <option value="completo" selected>Reporte Completo</option>
                            <option value="detallado">An√°lisis Extendido</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-purple" onclick="generarTesoreriaUnificado()">
                        Generar Reporte Consolidado
                    </button>
                    
                   
                </div>
            </div>
        </div>

   
        <!-- Reportes Contables Profesionales -->
        <div class="card">
            <h2>üßÆ Reportes Contables Profesionales</h2>
            <p>Documentos formales para presentaci√≥n ante contador y autoridades fiscales</p>
            
            <div class="reporte-grid">
                <!-- Tarjeta 1: Estado de Resultados (MANTENER) -->
                <div class="reporte-card contable">
                    <h3>üìà Estado de Resultados</h3>
                    <p><strong>P√©rdidas y Ganancias</strong><br/>
                    Muestra ingresos, gastos y resultado neto del per√≠odo. Esencial para declaraciones de impuestos y an√°lisis de rentabilidad.</p>
                    <button class="btn btn-primary" onclick="generarReporte('estado_resultados')">
                        üì• Descargar PDF
                    </button>
                </div>
                
                <!-- Tarjeta 2: Conciliaci√≥n Bancaria (MANTENER) -->
                <div class="reporte-card contable">
                    <h3>üè¶ Conciliaci√≥n Bancaria</h3>
                    <p><strong>Conciliaci√≥n de Saldos</strong><br/>
                    Compara saldos del sistema con extractos bancarios. Esencial para auditor√≠as.</p>
                    <button class="btn btn-primary" onclick="abrirModalConciliacion()">
                        üì• Generar Conciliaci√≥n
                    </button>
                </div>
            </div>
            
            <!-- ‚úÖ NOTA INFORMATIVA SOBRE LA CONSOLIDACI√ìN -->
            <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #2c3e50; font-size: 0.9em;">
                    <strong>üí° Nota:</strong> Los reportes de <strong>Flujo de Caja</strong> y <strong>Libro Diario Contable</strong> han sido consolidados en el nuevo 
                    <strong>Reporte Unificado de Tesorer√≠a</strong> para ofrecer un an√°lisis m√°s completo e integrado.
                </p>
            </div>
        </div>

        <!-- ======================================== -->
        <!-- SECCI√ìN NUEVA: GESTI√ìN DE DEP√ìSITOS BANCARIOS -->
        <!-- ======================================== -->
        <div class="card">
            <h2><i class="fas fa-piggy-bank"></i> Gesti√≥n de Dep√≥sitos Bancarios</h2>
            <p>Administraci√≥n y conciliaci√≥n de dep√≥sitos bancarios para control de tesorer√≠a</p>
            
            <!-- Estad√≠sticas R√°pidas -->
            <div class="estadisticas-container" id="estadisticasDepositos">
                <!-- Se llenar√° con JavaScript -->
                <div class="estadistica-card">
                    <div class="estadistica-label">Total Dep√≥sitos</div>
                    <div class="estadistica-valor">$0</div>
                    <div class="estadistica-label">Periodo actual</div>
                </div>
                <div class="estadistica-card">
                    <div class="estadistica-label">Conciliados</div>
                    <div class="estadistica-valor">0%</div>
                    <div class="estadistica-label">Tasa de conciliaci√≥n</div>
                </div>
                <div class="estadistica-card">
                    <div class="estadistica-label">Monto Pendiente</div>
                    <div class="estadistica-valor">$0</div>
                    <div class="estadistica-label">Por conciliar</div>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="filtros-container">
                <div class="filtro-group">
                    <label>Estado:</label>
                    <select id="filtroEstado" class="form-control" onchange="cargarDepositos()">
                        <option value="">Todos los estados</option>
                        <option value="REGISTRADO">Registrado</option>
                        <option value="CONCILIADO">Conciliado</option>
                        <option value="ANULADO">Anulado</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label>M√©todo de dep√≥sito:</label>
                    <select id="filtroMetodo" class="form-control" onchange="cargarDepositos()">
                        <option value="">Todos los m√©todos</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label>Mostrar:</label>
                    <select id="filtroMostrar" class="form-control" onchange="cargarDepositos()">
                        <option value="50">√öltimos 50</option>
                        <option value="100">√öltimos 100</option>
                        <option value="250">√öltimos 250</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="abrirModalDeposito('crear')">
                    <i class="fas fa-plus-circle"></i> Nuevo Dep√≥sito
                </button>
                <button class="btn btn-info" onclick="cargarEstadisticas()">
                    <i class="fas fa-chart-bar"></i> Actualizar Estad√≠sticas
                </button>
                <button class="btn btn-primary" onclick="cargarDepositos()">
                    <i class="fas fa-sync-alt"></i> Refrescar Lista
                </button>
            </div>
            
            <!-- Tabla de Dep√≥sitos -->
            <div class="table-container">
                <div id="loaderDepositos" class="loader" style="display: none;"></div>
                <table class="depositos-table" id="tablaDepositos">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Descripci√≥n</th>
                            <th>Monto</th>
                            <th>M√©todo</th>
                            <th>Cuenta</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Se llenar√° con JavaScript -->
                        <tr id="sinDepositos">
                            <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                                No hay dep√≥sitos para mostrar. <a href="#" onclick="abrirModalDeposito('crear')">Crear el primer dep√≥sito</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Paginaci√≥n -->
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="cargarMasDepositos()" id="btnCargarMas" style="display: none;">
                    <i class="fas fa-chevron-down"></i> Cargar m√°s dep√≥sitos
                </button>
            </div>
        </div>
        <!-- FIN SECCI√ìN DEP√ìSITOS BANCARIOS -->

        <!--------------------------------------- Reportes Gerenciales ------------------------------------------------------->
        <div class="card">
            <h2>üìä Reportes Gerenciales y Anal√≠ticos</h2>
            <p>An√°lisis avanzados para toma de decisiones estrat√©gicas y optimizaci√≥n del negocio</p>
            
            <div class="reporte-grid">
                <div class="reporte-card gerencial">
                    <h3>üìä An√°lisis de Gastos por Categor√≠a</h3>
                    <p><strong>Distribuci√≥n de Costos</strong><br/>
                    Gr√°ficos y an√°lisis de gastos por categor√≠a. Identifica √°reas de optimizaci√≥n.</p>
                    <button class="btn btn-success" onclick="generarReporte('analisis_gastos')">
                        üì• Descargar PDF
                    </button>
                </div>
                
                <div class="reporte-card gerencial">
                    <h3>üìà Tendencia de Ventas</h3>
                    <p><strong>An√°lisis de Comportamiento</strong><br/>
                    Evoluci√≥n de ventas en el tiempo. Detecta patrones y estacionalidad.</p>
                    <button class="btn btn-success" onclick="generarReporte('tendencia_ventas')">
                        üì• Descargar PDF
                    </button>
                </div>
                
                <div class="reporte-card gerencial">
                    <h3>ü§ñ Recomendaciones con IA</h3>
                    <p><strong>An√°lisis Predictivo</strong><br/>
                    Recomendaciones inteligentes basadas en datos hist√≥ricos y tendencias.</p>
                    <button class="btn btn-success" onclick="generarReporte('ia_predictivo')">
                        üì• Descargar PDF
                    </button>
                </div>
                
                <div class="reporte-card gerencial">
                    <h3>üì¶ An√°lisis de Inventarios</h3>
                    <p><strong>Gesti√≥n de Stock</strong><br/>
                    Rotaci√≥n, puntos de reorden y optimizaci√≥n de inventarios.</p>
                    <button class="btn btn-success" onclick="generarReporte('analisis_inventarios')">
                        üì• Descargar PDF
                    </button>
                </div>

                <!-- üöÄ NUEVO REPORTE AVANZADO UNIFICADO -->
                <div class="reporte-card gerencial">
                    <h3><i class="fas fa-robot"></i> Reporte Avanzado Ventas + IA</h3>
                    <p><strong>Reporte Unificado Inteligente</strong><br/>
                    Combina an√°lisis de ventas, tendencias, ML y recomendaciones IA en un solo reporte interactivo.</p>
                    <div class="nav-buttons">
                        <a href="{{ url_for('reporte_ventas_avanzado') }}" class="btn btn-primary">
                            <i class="fas fa-chart-line"></i> Ver Reporte Web
                        </a>
                    </div>
                    <div style="margin-top: 10px;">
                        <span class="badge bg-success">NUEVO</span>
                        <span class="badge bg-info">ML</span>
                        <span class="badge bg-warning">UNIFICADO</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conciliaci√≥n Bancaria -->
    <div id="modalConciliacion" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px;">üè¶ Conciliaci√≥n Bancaria</h3>
            
            <div class="form-group">
                <label>Fecha de Corte:</label>
                <input type="date" id="fecha_corte" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Saldo seg√∫n Extracto Bancario:</label>
                <input type="number" step="0.01" id="saldo_extracto" class="form-control" placeholder="Ej: 1,500,000" required>
                <small>Ingresa el saldo que aparece en tu extracto bancario</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="generarConciliacion()" style="flex: 1;">
                    üìä Generar Conciliaci√≥n
                </button>
                <button type="button" class="btn" onclick="cerrarModalConciliacion()" style="flex: 1; background: #95a5a6; color: white;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Dep√≥sitos Bancarios (Crear/Editar) -->
    <div id="modalDeposito" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDepositoTitulo">Nuevo Dep√≥sito Bancario</h3>
                <button class="close-modal" onclick="cerrarModalDeposito()">&times;</button>
            </div>
            <form id="formDeposito" onsubmit="guardarDeposito(event)">
                <input type="hidden" id="depositoId" value="">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fechaDeposito">Fecha de dep√≥sito: *</label>
                        <input type="date" id="fechaDeposito" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="montoDeposito">Monto: *</label>
                        <input type="number" step="0.01" id="montoDeposito" class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="form-group form-full-width">
                        <label for="descripcionDeposito">Descripci√≥n:</label>
                        <input type="text" id="descripcionDeposito" class="form-control" placeholder="Ej: Dep√≥sito de cierre diario">
                    </div>
                    <div class="form-group">
                        <label for="referenciaDeposito">Referencia:</label>
                        <input type="text" id="referenciaDeposito" class="form-control" placeholder="Ej: TRANSF-001">
                    </div>
                    <div class="form-group">
                        <label for="cuentaDeposito">Cuenta bancaria:</label>
                        <input type="text" id="cuentaDeposito" class="form-control" placeholder="Ej: Cuenta Principal">
                    </div>
                    <div class="form-group">
                        <label for="metodoDeposito">M√©todo de dep√≥sito: *</label>
                        <select id="metodoDeposito" class="form-control" required>
                            <option value="">Seleccionar...</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="cheque">Cheque</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="estadoDeposito">Estado:</label>
                        <select id="estadoDeposito" class="form-control">
                            <option value="REGISTRADO">Registrado</option>
                            <option value="CONCILIADO">Conciliado</option>
                            <option value="ANULADO">Anulado</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalDeposito()">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnGuardarDeposito">
                        <i class="fas fa-save"></i> Guardar Dep√≥sito
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="modalConfirmacionTitulo">Confirmar acci√≥n</h3>
                <button class="close-modal" onclick="cerrarModalConfirmacion()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p id="modalConfirmacionMensaje">¬øEst√°s seguro de realizar esta acci√≥n?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalConfirmacion()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarAccion">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let paginaActual = 1;
        const limitePorPagina = 50;
        let hayMasDepositos = true;

        // ========== FUNCIONES GENERALES ==========
        function inicializarFechas() {
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            document.getElementById('fecha_inicio').value = formatearFecha(hace30Dias);
            document.getElementById('fecha_fin').value = formatearFecha(hoy);
        }
        
        function formatearFecha(fecha) {
            return fecha.toISOString().split('T')[0];
        }
        
        function establecerPeriodo(periodo) {
            const hoy = new Date();
            const fechaInicio = new Date();
            
            switch(periodo) {
                case 'semana':
                    fechaInicio.setDate(hoy.getDate() - 7);
                    break;
                case 'mes':
                    fechaInicio.setDate(hoy.getDate() - 30);
                    break;
                case 'trimestre':
                    fechaInicio.setDate(hoy.getDate() - 90);
                    break;
            }
            
            document.getElementById('fecha_inicio').value = formatearFecha(fechaInicio);
            document.getElementById('fecha_fin').value = formatearFecha(hoy);
            
            // Actualizar dep√≥sitos cuando se cambia el per√≠odo
            setTimeout(() => cargarDepositos(), 100);
        }

        // ========== FUNCIONES DE DEP√ìSITOS BANCARIOS ==========
        function cargarDepositos(resetear = true) {
            if (resetear) {
                paginaActual = 1;
                hayMasDepositos = true;
                const tbody = document.getElementById('tablaDepositos').querySelector('tbody');
                if (tbody) tbody.innerHTML = '';
            }
            
            if (!hayMasDepositos) return;
            
            const loader = document.getElementById('loaderDepositos');
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            const estado = document.getElementById('filtroEstado').value;
            const metodo = document.getElementById('filtroMetodo').value;
            const mostrar = document.getElementById('filtroMostrar').value;
            
            let url = `/depositos_bancarios?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
            if (estado) url += `&estado=${estado}`;
            if (metodo) url += `&metodo=${metodo}`;
            
            if (loader) loader.style.display = 'block';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 403) {
                            mostrarError('No tienes permisos para acceder a esta secci√≥n');
                            return null;
                        }
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    if (data.success) {
                        renderizarDepositos(data.depositos);
                        actualizarEstadisticas(data.depositos);
                        
                        // Controlar paginaci√≥n
                        if (data.depositos.length < limitePorPagina) {
                            hayMasDepositos = false;
                            const btnCargarMas = document.getElementById('btnCargarMas');
                            if (btnCargarMas) btnCargarMas.style.display = 'none';
                        } else {
                            const btnCargarMas = document.getElementById('btnCargarMas');
                            if (btnCargarMas) btnCargarMas.style.display = 'block';
                        }
                    } else {
                        mostrarError('Error al cargar dep√≥sitos: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarError('Error de conexi√≥n al cargar dep√≥sitos');
                })
                .finally(() => {
                    if (loader) loader.style.display = 'none';
                });
        }
        
        function cargarMasDepositos() {
            paginaActual++;
            cargarDepositos(false);
        }
        
        function renderizarDepositos(depositos) {
            const tbody = document.getElementById('tablaDepositos').querySelector('tbody');
            if (!tbody) return;
            
            if (!depositos || depositos.length === 0) {
                if (paginaActual === 1) {
                    tbody.innerHTML = `
                        <tr id="sinDepositos">
                            <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                                No hay dep√≥sitos para mostrar. <a href="#" onclick="abrirModalDeposito('crear')">Crear el primer dep√≥sito</a>
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            // Eliminar el mensaje de "sin dep√≥sitos" si existe
            const sinDepositos = document.getElementById('sinDepositos');
            if (sinDepositos) sinDepositos.remove();
            
            depositos.forEach(deposito => {
                const fila = document.createElement('tr');
                fila.setAttribute('data-id', deposito.id);
                
                const claseEstado = `estado-${deposito.estado ? deposito.estado.toLowerCase() : 'registrado'}`;
                
                // Formatear monto SIN decimales si es entero
                const monto = parseFloat(deposito.monto);
                const montoFormateado = monto % 1 === 0 ? 
                    `$${monto.toLocaleString('es-CO')}` : 
                    `$${monto.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                
                let acciones = '';
                if (deposito.estado === 'REGISTRADO') {
                    acciones = `
                        <button class="btn btn-success btn-sm" onclick="conciliarDeposito(${deposito.id})" title="Marcar como conciliado">
                            <i class="fas fa-check"></i> Conciliar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="abrirModalDeposito('editar', ${deposito.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmarEliminarDeposito(${deposito.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                } else if (deposito.estado === 'CONCILIADO') {
                    acciones = `
                        <button class="btn btn-info btn-sm" onclick="abrirModalDeposito('editar', ${deposito.id})" title="Ver/Editar">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                } else {
                    acciones = `
                        <button class="btn btn-info btn-sm" onclick="abrirModalDeposito('editar', ${deposito.id})" title="Ver">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                }
                
                fila.innerHTML = `
                    <td>${deposito.id}</td>
                    <td>${deposito.fecha_deposito}</td>
                    <td>${deposito.descripcion || 'Sin descripci√≥n'}</td>
                    <td><strong>${montoFormateado}</strong></td>
                    <td><span class="badge bg-info">${deposito.metodo_deposito || 'No especificado'}</span></td>
                    <td>${deposito.cuenta_bancaria || 'No especificada'}</td>
                    <td><span class="${claseEstado}">${deposito.estado}</span></td>
                    <td>
                        <div class="acciones-cell">
                            ${acciones}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(fila);
            });
        }
        
        function cargarEstadisticas() {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            
            if (!fechaInicio || !fechaFin) {
                mostrarError('Selecciona un per√≠odo para ver estad√≠sticas');
                return;
            }
            
            fetch(`/depositos_bancarios/estadisticas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        actualizarEstadisticasUI(data.estadisticas);
                    }
                })
                .catch(error => {
                    console.error('Error cargando estad√≠sticas:', error);
                    mostrarError('Error al cargar estad√≠sticas');
                });
        }
        
        function actualizarEstadisticas(depositos) {
            if (!depositos || depositos.length === 0) {
                actualizarEstadisticasUI({
                    total_depositos: 0,
                    total_monto: 0,
                    depositos_conciliados: 0,
                    monto_conciliado: 0,
                    porcentaje_conciliacion: 0
                });
                return;
            }
            
            const totalDepositos = depositos.length;
            const totalMonto = depositos.reduce((sum, d) => sum + parseFloat(d.monto), 0);
            const depositosConciliados = depositos.filter(d => d.estado === 'CONCILIADO');
            const totalConciliados = depositosConciliados.length;
            const montoConciliado = depositosConciliados.reduce((sum, d) => sum + parseFloat(d.monto), 0);
            const porcentajeConciliacion = totalDepositos > 0 ? (totalConciliados / totalDepositos * 100) : 0;
            
            actualizarEstadisticasUI({
                total_depositos: totalDepositos,
                total_monto: totalMonto,
                depositos_conciliados: totalConciliados,
                monto_conciliado: montoConciliado,
                porcentaje_conciliacion: porcentajeConciliacion
            });
        }
        
        function actualizarEstadisticasUI(estadisticas) {
            const container = document.getElementById('estadisticasDepositos');
            if (!container) return;
            
            const cards = container.querySelectorAll('.estadistica-card');
            
            if (cards.length >= 3) {
                // Formatear montos sin decimales
                const formatMonto = (monto) => {
                    const num = parseFloat(monto);
                    return num % 1 === 0 ? 
                        `$${num.toLocaleString('es-CO')}` : 
                        `$${num.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                };
                
                cards[0].querySelector('.estadistica-valor').textContent = formatMonto(estadisticas.total_monto);
                cards[1].querySelector('.estadistica-valor').textContent = `${estadisticas.porcentaje_conciliacion.toFixed(0)}%`;
                cards[2].querySelector('.estadistica-valor').textContent = formatMonto(estadisticas.total_monto - estadisticas.monto_conciliado);
            }
        }
        
        function abrirModalDeposito(accion, id = null) {
            const modal = document.getElementById('modalDeposito');
            const titulo = document.getElementById('modalDepositoTitulo');
            const form = document.getElementById('formDeposito');
            
            if (!modal || !titulo || !form) {
                mostrarError('Error: No se pudo abrir el modal');
                return;
            }
            
            if (accion === 'crear') {
                titulo.textContent = 'Nuevo Dep√≥sito Bancario';
                form.reset();
                document.getElementById('depositoId').value = '';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fechaDeposito').value = today;
                document.getElementById('estadoDeposito').value = 'REGISTRADO';
            } else if (accion === 'editar' && id) {
                titulo.textContent = 'Editar Dep√≥sito Bancario';
                
                // Cargar datos del dep√≥sito
                fetch(`/depositos_bancarios/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.deposito) {
                            const d = data.deposito;
                            document.getElementById('depositoId').value = d.id;
                            document.getElementById('fechaDeposito').value = d.fecha_deposito;
                            document.getElementById('montoDeposito').value = d.monto;
                            document.getElementById('descripcionDeposito').value = d.descripcion || '';
                            document.getElementById('referenciaDeposito').value = d.referencia || '';
                            document.getElementById('cuentaDeposito').value = d.cuenta_bancaria || '';
                            document.getElementById('metodoDeposito').value = d.metodo_deposito || 'efectivo';
                            document.getElementById('estadoDeposito').value = d.estado || 'REGISTRADO';
                        } else {
                            mostrarError(data.error || 'Error al cargar el dep√≥sito');
                            cerrarModalDeposito();
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando dep√≥sito:', error);
                        mostrarError('Error de conexi√≥n al cargar el dep√≥sito');
                        cerrarModalDeposito();
                    });
            }
            
            modal.style.display = 'block';
        }
        
        function cerrarModalDeposito() {
            const modal = document.getElementById('modalDeposito');
            if (modal) {
                modal.style.display = 'none';
            }
            const form = document.getElementById('formDeposito');
            if (form) {
                form.reset();
            }
        }
        
        function formatearMonto(monto) {
            const numero = parseFloat(monto);
            // Si es un n√∫mero entero, mostrar sin decimales
            if (numero % 1 === 0) {
                return numero.toLocaleString('es-CO'); // Formato colombiano sin decimales
            } else {
                // Si tiene decimales, mostrar con 2 decimales
                return numero.toLocaleString('es-CO', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }
        function guardarDeposito(event) {
            if (event) {
                event.preventDefault();
            }
            
            const id = document.getElementById('depositoId').value;
            const esNuevo = !id;
            const url = esNuevo ? '/depositos_bancarios/crear' : `/depositos_bancarios/editar/${id}`;
            const metodo = 'POST';
            
            // Validar campos
            const fecha = document.getElementById('fechaDeposito').value;
            const monto = document.getElementById('montoDeposito').value;
            const metodoDep = document.getElementById('metodoDeposito').value;
            
            if (!fecha) {
                mostrarError('La fecha es obligatoria');
                return false;
            }
            
            if (!monto || parseFloat(monto) <= 0) {
                mostrarError('El monto debe ser mayor a 0');
                return false;
            }
            
            if (!metodoDep) {
                mostrarError('El m√©todo de dep√≥sito es obligatorio');
                return false;
            }
            
            const depositoData = {
                fecha_deposito: fecha,
                monto: parseFloat(monto),
                descripcion: document.getElementById('descripcionDeposito').value,
                referencia: document.getElementById('referenciaDeposito').value,
                cuenta_bancaria: document.getElementById('cuentaDeposito').value,
                metodo_deposito: metodoDep,
                estado: document.getElementById('estadoDeposito').value
            };
            
            const btnGuardar = document.getElementById('btnGuardarDeposito');
            if (!btnGuardar) return false;
            
            const textoOriginal = btnGuardar.innerHTML;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            btnGuardar.disabled = true;
            
            fetch(url, {
                method: metodo,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(depositoData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarExito(esNuevo ? 'Dep√≥sito creado exitosamente' : 'Dep√≥sito actualizado exitosamente');
                    cerrarModalDeposito();
                    cargarDepositos(true);
                    cargarEstadisticas();
                } else {
                    mostrarError(data.error || 'Error al guardar el dep√≥sito');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n al guardar el dep√≥sito');
            })
            .finally(() => {
                btnGuardar.innerHTML = textoOriginal;
                btnGuardar.disabled = false;
            });
            
            return false;
        }
        
        function conciliarDeposito(id) {
            mostrarConfirmacion(
                'Conciliar Dep√≥sito',
                '¬øEst√°s seguro de marcar este dep√≥sito como conciliado? Esta acci√≥n no se puede deshacer.',
                () => {
                    fetch(`/depositos_bancarios/conciliar/${id}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarExito('Dep√≥sito conciliado exitosamente');
                            cargarDepositos(true);
                            cargarEstadisticas();
                        } else {
                            mostrarError(data.error || 'Error al conciliar el dep√≥sito');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarError('Error de conexi√≥n al conciliar el dep√≥sito');
                    });
                }
            );
        }
        
        function confirmarEliminarDeposito(id) {
            mostrarConfirmacion(
                'Eliminar Dep√≥sito',
                '¬øEst√°s seguro de eliminar este dep√≥sito? Esta acci√≥n no se puede deshacer.',
                () => eliminarDeposito(id)
            );
        }
        
        function eliminarDeposito(id) {
            fetch(`/depositos_bancarios/eliminar/${id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarExito('Dep√≥sito eliminado exitosamente');
                    cargarDepositos(true);
                    cargarEstadisticas();
                } else {
                    mostrarError(data.error || 'Error al eliminar el dep√≥sito');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexi√≥n al eliminar el dep√≥sito');
            });
        }
        
        // ========== FUNCIONES DE CONFIRMACI√ìN ==========
        function mostrarConfirmacion(titulo, mensaje, callback) {
            const modal = document.getElementById('modalConfirmacion');
            const tituloElem = document.getElementById('modalConfirmacionTitulo');
            const mensajeElem = document.getElementById('modalConfirmacionMensaje');
            const btnConfirmar = document.getElementById('btnConfirmarAccion');
            
            if (!modal || !tituloElem || !mensajeElem || !btnConfirmar) {
                if (callback) callback();
                return;
            }
            
            tituloElem.textContent = titulo;
            mensajeElem.textContent = mensaje;
            btnConfirmar.onclick = function() {
                if (callback) callback();
                cerrarModalConfirmacion();
            };
            modal.style.display = 'block';
        }
        
        function cerrarModalConfirmacion() {
            const modal = document.getElementById('modalConfirmacion');
            if (modal) modal.style.display = 'none';
        }
        
        // ========== FUNCIONES DE MENSAJES ==========
        function mostrarMensaje(tipo, mensaje) {
            // Crear elemento de mensaje
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.textContent = mensaje;
            
            // Agregar al contenedor de mensajes
            const container = document.querySelector('.flash-messages');
            if (container) {
                container.appendChild(alertDiv);
                
                // Eliminar despu√©s de 5 segundos
                setTimeout(() => {
                    if (alertDiv.parentNode === container) {
                        container.removeChild(alertDiv);
                    }
                }, 5000);
            }
        }
        
        function mostrarError(mensaje) {
            mostrarMensaje('error', mensaje);
        }
        
        function mostrarExito(mensaje) {
            mostrarMensaje('success', mensaje);
        }
        
        // ========== FUNCIONES DE CONCILIACI√ìN BANCARIA ==========
        function abrirModalConciliacion() {
            const modal = document.getElementById('modalConciliacion');
            const fechaCorte = document.getElementById('fecha_corte');
            if (modal && fechaCorte) {
                fechaCorte.value = new Date().toISOString().split('T')[0];
                modal.style.display = 'block';
            }
        }

        function cerrarModalConciliacion() {
            const modal = document.getElementById('modalConciliacion');
            if (modal) modal.style.display = 'none';
        }

        function generarConciliacion() {
            const fechaCorte = document.getElementById('fecha_corte').value;
            const saldoExtracto = document.getElementById('saldo_extracto').value;
            
            if (!fechaCorte || !saldoExtracto) {
                mostrarError('Por favor completa todos los campos');
                return;
            }
            
            if (parseFloat(saldoExtracto) <= 0) {
                mostrarError('El saldo del extracto debe ser mayor a 0');
                return;
            }
            
            const boton = event.target;
            const textoOriginal = boton.textContent;
            boton.textContent = '‚è≥ Generando...';
            boton.disabled = true;
            
            const url = `/generar_reporte_conciliacion?fecha_corte=${fechaCorte}&saldo_extracto=${saldoExtracto}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    if (blob.size === 0) {
                        throw new Error('El archivo PDF est√° vac√≠o');
                    }
                    
                    const urlBlob = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = urlBlob;
                    a.download = `conciliacion_bancaria_${fechaCorte}.pdf`;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(urlBlob);
                    }, 1000);
                    
                    cerrarModalConciliacion();
                    mostrarExito('Reporte de conciliaci√≥n generado exitosamente');
                })
                .catch(error => {
                    console.error('Error al generar conciliaci√≥n:', error);
                    mostrarError('Error al generar el reporte. Verifica la consola del navegador.');
                })
                .finally(() => {
                    boton.textContent = textoOriginal;
                    boton.disabled = false;
                });
        }

        // ========== FUNCI√ìN GENERAR REPORTE ==========
        function generarReporte(tipo) {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            
            if (!fechaInicio || !fechaFin) {
                mostrarError('Por favor selecciona ambas fechas');
                return;
            }
            
            if (fechaInicio > fechaFin) {
                mostrarError('La fecha de inicio no puede ser mayor a la fecha fin');
                return;
            }
            
            let url = '';
            switch(tipo) {
                case 'estado_resultados':
                    url = `/generar_reporte_estado_resultados?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                    break;
                case 'analisis_gastos':
                    url = `/generar_reporte_analisis_gastos?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                    break;
                case 'tendencia_ventas':
                    url = `/generar_reporte_tendencia_ventas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                    break;
                case 'ia_predictivo':
                    url = `/generar_reporte_ia_predictivo?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                    break;
                case 'analisis_inventarios':
                    url = `/generar_reporte_analisis_inventarios?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                    break;
                default:
                    mostrarError('Reporte en desarrollo');
                    return;
            }
            
            window.open(url, '_blank');
        }

        // ========== NUEVA FUNCI√ìN: REPORTE UNIFICADO DE TESORER√çA ==========
        function generarTesoreriaUnificado() {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            const nivelDetalle = document.getElementById('nivel_detalle_tesoreria').value;
            
            if (!fechaInicio || !fechaFin) {
                mostrarError('Por favor selecciona ambas fechas');
                return;
            }
            
            if (fechaInicio > fechaFin) {
                mostrarError('La fecha de inicio no puede ser mayor a la fecha fin');
                return;
            }
            
            const url = `/generar_reporte_tesoreria_unificado?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}&nivel_detalle=${nivelDetalle}`;
            
            const niveles = {
                'resumen': 'Resumen Ejecutivo',
                'completo': 'Reporte Completo', 
                'detallado': 'Detalle Extendido'
            };
            
            if (confirm(`üéØ ¬øGenerar Reporte Unificado de Tesorer√≠a?\n\nüìÖ Per√≠odo: ${fechaInicio} a ${fechaFin}\nüìä Nivel: ${niveles[nivelDetalle]}`)) {
                window.open(url, '_blank');
            }
        }

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFechas();
            
            // Cargar dep√≥sitos al iniciar
            setTimeout(() => {
                cargarDepositos();
                cargarEstadisticas();
            }, 500);
            
            // Cerrar modales al hacer clic fuera
            document.addEventListener('click', function(event) {
                if (event.target === document.getElementById('modalConciliacion')) {
                    cerrarModalConciliacion();
                }
                if (event.target === document.getElementById('modalDeposito')) {
                    cerrarModalDeposito();
                }
                if (event.target === document.getElementById('modalConfirmacion')) {
                    cerrarModalConfirmacion();
                }
            });
            
            // Cerrar modales con ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    cerrarModalConciliacion();
                    cerrarModalDeposito();
                    cerrarModalConfirmacion();
                }
            });
        });
    </script>
</body>
</html>