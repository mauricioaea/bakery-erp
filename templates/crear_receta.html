<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if editar %}Editar{% else %}Crear{% endif %} Receta - Panader√≠a</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .btn { 
            background: #667eea; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 5px; 
            text-decoration: none; 
            border: none; 
            cursor: pointer; 
            display: inline-block;
            margin-right: 10px;
            font-size: 14px;
        }
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-remove {
            background: #dc3545;
            padding: 10px 15px;
        }
        .btn-remove:hover {
            background: #c82333;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #333;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        .ingredientes-section { 
            margin-top: 30px; 
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .ingredientes-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .ingrediente-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            align-items: end; 
        }
        .ingrediente-row select, .ingrediente-row input { 
            flex: 1; 
        }
        .navigation-links {
            margin-top: 10px;
        }
        .alert {
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .resumen-box {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        .precio-real-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        .precio-info {
            background: #fff3cd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
            font-size: 0.9em;
        }
        .calculos-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .calculos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .calculo-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        .calculo-item.ganancia {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        .calculo-item.precio-final {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .calculo-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        .calculo-valor {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: black; }
        .badge-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>{% if editar %}‚úèÔ∏è Editar{% else %}üçû Crear Nueva{% endif %} Receta</h1>
                <div class="navigation-links">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">üè† Volver al Dashboard</a>
                    <a href="{{ url_for('recetas') }}" class="btn btn-secondary">üìã Lista de Recetas</a>
                </div>
            </div>
        </div>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST">
            <div class="form-group">
                <label>Nombre de la Receta *</label>
                <input type="text" name="nombre" required placeholder="Ej: Pan 6 Cereales y Miel" 
                       value="{{ receta.nombre if receta else '' }}">
            </div>

            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea name="descripcion" rows="3" placeholder="Descripci√≥n del producto...">{{ receta.descripcion if receta else '' }}</textarea>
            </div>

            <div class="form-group">
                <label>Categor√≠a *</label>
                <select name="categoria" required>
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="pan" {% if receta and receta.categoria == 'pan' %}selected{% endif %}>Pan</option>
                    <option value="torta" {% if receta and receta.categoria == 'torta' %}selected{% endif %}>Torta</option>
                    <option value="galleta" {% if receta and receta.categoria == 'galleta' %}selected{% endif %}>Galleta</option>
                    <option value="pasteleria" {% if receta and receta.categoria == 'pasteleria' %}selected{% endif %}>Pasteler√≠a</option>
                    <option value="bolleria" {% if receta and receta.categoria == 'bolleria' %}selected{% endif %}>Boller√≠a</option>
                    <option value="otro" {% if receta and receta.categoria == 'otro' %}selected{% endif %}>Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label>Peso por Unidad (gramos) *</label>
                <input type="number" name="peso_unidad_gramos" step="0.01" required placeholder="350" min="1"
                       value="{{ receta.peso_unidad_gramos if receta else '' }}"
                       oninput="actualizarCalculosCompletos()">
                <small style="color: #666; font-size: 12px;">Peso de cada unidad individual antes del horneado</small>
            </div>

            <div class="form-group">
                <label>% P√©rdida por Horneado</label>
                <input type="number" name="porcentaje_perdida" step="0.01" value="{{ receta.porcentaje_perdida if receta else '10.0' }}" min="0" max="50" placeholder="10.0"
                       oninput="actualizarCalculosCompletos()">
                <small style="color: #666; font-size: 12px;">Porcentaje de masa que se pierde durante el horneado</small>
            </div>

            <!-- ‚úÖ NUEVA SECCI√ìN: C√ÅLCULOS AUTOM√ÅTICOS CON 45% CIF + 45% GANANCIA -->
            <div class="calculos-section">
                <h3>üìä C√°lculos Autom√°ticos de Costos y Precios</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    El sistema calcula autom√°ticamente: <strong>Costo MP ‚Üí +45% CIF ‚Üí +45% Ganancia ‚Üí Precio Venta Final</strong>
                </p>
                
                <div class="calculos-grid">
                    <div class="calculo-item">
                        <div class="calculo-label">Costo Materia Prima</div>
                        <div class="calculo-valor" id="costo-mp">$0</div>
                    </div>
                    <div class="calculo-item">
                        <div class="calculo-label">CIF (45%)</div>
                        <div class="calculo-valor" id="costo-cif">$0</div>
                    </div>
                    <div class="calculo-item">
                        <div class="calculo-label">Costo Total</div>
                        <div class="calculo-valor" id="costo-total">$0</div>
                    </div>
                    <div class="calculo-item ganancia">
                        <div class="calculo-label">Ganancia (45%)</div>
                        <div class="calculo-valor" id="ganancia">$0</div>
                    </div>
                    <div class="calculo-item precio-final">
                        <div class="calculo-label">Precio Total Preparaci√≥n</div>
                        <div class="calculo-valor" id="precio-total">$0</div>
                    </div>
                    <div class="calculo-item precio-final">
                        <div class="calculo-label">Precio Venta por Unidad</div>
                        <div class="calculo-valor" id="precio-unidad">$0</div>
                    </div>
                </div>

                <!-- M√âTRICAS DE RENTABILIDAD -->
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
                    <strong>üìà M√©tricas de Rentabilidad:</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>
                            <small>Margen de Contribuci√≥n:</small>
                            <div id="margen-contribucion">-</div>
                        </div>
                        <div>
                            <small>Punto de Equilibrio:</small>
                            <div id="punto-equilibrio">-</div>
                        </div>
                        <div>
                            <small>Rentabilidad:</small>
                            <div id="rentabilidad-porcentaje">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ SECCI√ìN: PRECIO DE VENTA REAL (COMPARACI√ìN) -->
            <div class="precio-real-section">
                <h3>üí∞ Precio de Venta Real (Comparaci√≥n)</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Ingresa el precio al que realmente vendes este producto para comparar con el precio calculado.
                </p>
                
                <div class="form-group">
                    <label>Precio de Venta Real (OPCIONAL)</label>
                    <input type="number" name="precio_venta_real" step="0.01" min="0" 
                           placeholder="Ej: 6000" 
                           value="{{ receta.precio_venta_real if receta and receta.precio_venta_real else '' }}"
                           oninput="actualizarComparacionPrecio(this.value)">
                    <small style="color: #666; font-size: 12px;">
                        Si no ingresas un precio real, el sistema usar√° el precio calculado autom√°ticamente.
                    </small>
                </div>

                <!-- COMPARACI√ìN EN TIEMPO REAL -->
                <div id="comparacion-precio" class="precio-info" style="display: none;">
                    <strong>üìä Comparaci√≥n de Precios:</strong><br>
                    <span id="diferencia-precio">Diferencia: $0</span> | 
                    <span id="recomendacion-precio">Recomendaci√≥n: -</span>
                </div>
            </div>

            <!-- SECCI√ìN DE INGREDIENTES ACTUALIZADA -->
            <div class="ingredientes-section">
                <h3>üß™ Ingredientes</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Agrega los ingredientes con sus cantidades en <strong>gramos</strong>. El sistema calcular√° autom√°ticamente los porcentajes.
                </p>
                
                <div id="ingredientes-container">
                    <!-- Los ingredientes se agregar√°n aqu√≠ din√°micamente -->
                    {% if receta and receta.ingredientes %}
                        {% for ingrediente in receta.ingredientes %}
                        <div class="ingrediente-row">
                            <select name="ingredientes[{{ loop.index0 }}][materia_prima_id]" required onchange="actualizarCalculosCompletos()">
                                <option value="">Seleccionar materia prima</option>
                                {% for mp in materias_primas %}
                                <option value="{{ mp.id }}" 
                                        data-precio="{{ mp.precio_compra }}" 
                                        data-unidad="{{ mp.unidad_medida }}"
                                        {% if ingrediente.materia_prima_id == mp.id %}selected{% endif %}>
                                    {{ mp.nombre }} ({{ mp.unidad_medida }})
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" name="ingredientes[{{ loop.index0 }}][gramos]" 
                                   step="0.1" placeholder="Gramos" required min="0.1" 
                                   value="{{ ingrediente.cantidad_gramos }}"
                                   oninput="actualizarCalculosCompletos()">
                            <button type="button" onclick="removerIngrediente(this)" 
                                    class="btn btn-remove" title="Eliminar ingrediente">
                                ‚ùå
                            </button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <!-- RESUMEN EN TIEMPO REAL -->
                <div class="resumen-box">
                    <strong>üìä Resumen de la f√≥rmula:</strong><br>
                    <span id="peso-total">0</span>g peso total | 
                    <span id="unidades-total">0</span> unidades obtenidas |
                    <span id="costo-mp-resumen">$0</span> costo MP
                </div>
                
                <button type="button" id="btn-agregar-ingrediente" class="btn" style="margin-top: 15px;">
                    ‚ûï Agregar Ingrediente
                </button>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <button type="submit" class="btn btn-success" style="padding: 12px 25px; font-size: 16px;">
                    üíæ {% if editar %}Actualizar{% else %}Guardar{% endif %} Receta
                </button>
                <a href="{{ url_for('recetas') }}" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <script>
        // ‚úÖ SISTEMA DE RECETAS - VERSI√ìN CORREGIDA Y SIMPLIFICADA
        console.log('‚úÖ Inicializando sistema de recetas...');

        // ‚úÖ FUNCI√ìN PRINCIPAL - AGREGAR INGREDIENTE
        function agregarIngrediente() {
            console.log('‚ûï EJECUTANDO agregarIngrediente...');
            
            const container = document.getElementById('ingredientes-container');
            if (!container) {
                console.error('‚ùå ERROR: No se encontr√≥ el contenedor de ingredientes');
                return;
            }
            
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'ingrediente-row';
            row.innerHTML = `
                <select name="ingredientes[${index}][materia_prima_id]" required onchange="actualizarCalculosCompletos()">
                    <option value="">Seleccionar materia prima</option>
                    {% for mp in materias_primas %}
                    <option value="{{ mp.id }}" data-precio="{{ mp.precio_compra }}" data-unidad="{{ mp.unidad_medida }}">
                        {{ mp.nombre }} ({{ mp.unidad_medida }})
                    </option>
                    {% endfor %}
                </select>
                <input type="number" name="ingredientes[${index}][gramos]" 
                       step="0.1" placeholder="Gramos" required min="0.1" 
                       oninput="actualizarCalculosCompletos()">
                <button type="button" onclick="removerIngrediente(this)" 
                        class="btn btn-remove" title="Eliminar ingrediente">
                    ‚ùå
                </button>
            `;
            
            container.appendChild(row);
            console.log('‚úÖ Ingrediente agregado correctamente');
            actualizarCalculosCompletos();
        }

        // ‚úÖ FUNCI√ìN PARA ELIMINAR INGREDIENTE
        function removerIngrediente(boton) {
            const item = boton.parentElement;
            item.remove();
            console.log('üóëÔ∏è Ingrediente eliminado');
            actualizarCalculosCompletos();
        }

        // ‚úÖ FUNCI√ìN PARA CALCULAR COSTOS (SIN preciosMP)
        function calcularCostoIngredientes() {
            const rows = document.querySelectorAll('.ingrediente-row');
            let costoTotal = 0;
            let pesoTotal = 0;
            
            rows.forEach(row => {
                const select = row.querySelector('select');
                const input = row.querySelector('input[type="number"]');
                
                if (select && select.value && input && input.value) {
                    // Obtener precio directamente del data-atributo
                    const option = select.options[select.selectedIndex];
                    const precioUnitario = parseFloat(option.dataset.precio) || 0;
                    const cantidadGramos = parseFloat(input.value) || 0;
                    const unidadMedida = option.dataset.unidad;
                    
                    // Convertir a gramos si es necesario
                    let factorConversion = 1;
                    if (unidadMedida === 'kg') factorConversion = 1000;
                    if (unidadMedida === 'lb') factorConversion = 453.592;
                    
                    const costoIngrediente = (cantidadGramos / factorConversion) * precioUnitario;
                    costoTotal += costoIngrediente;
                    pesoTotal += cantidadGramos;
                }
            });
            
            return { costoTotal, pesoTotal };
        }

        // ‚úÖ FUNCI√ìN PRINCIPAL DE C√ÅLCULOS
        function actualizarCalculosCompletos() {
            console.log('üìä Ejecutando actualizarCalculosCompletos...');
            
            const { costoTotal, pesoTotal } = calcularCostoIngredientes();
            
            // Calcular unidades obtenidas considerando p√©rdida por horneado
            const pesoUnidadInput = document.querySelector('input[name="peso_unidad_gramos"]');
            const porcentajePerdidaInput = document.querySelector('input[name="porcentaje_perdida"]');
            
            const pesoUnidad = parseFloat(pesoUnidadInput?.value) || 0;
            const porcentajePerdida = parseFloat(porcentajePerdidaInput?.value) || 0;
            
            // Peso despu√©s de horneado (considerando p√©rdida)
            const pesoHorneado = pesoTotal * (1 - porcentajePerdida / 100);
            const unidadesObtenidas = pesoUnidad > 0 ? Math.floor(pesoHorneado / pesoUnidad) : 0;
            
            // APLICAR F√ìRMULAS DEL EXCEL: 45% CIF + 45% GANANCIA
            const costoMP = costoTotal;
            const cif = costoMP * 0.45;
            const costoTotalConCIF = costoMP + cif;
            const ganancia = costoTotalConCIF * 0.45;
            const precioTotalPreparacion = costoTotalConCIF + ganancia;
            const precioVentaUnidad = unidadesObtenidas > 0 ? precioTotalPreparacion / unidadesObtenidas : 0;
            
            // Actualizar displays usando funci√≥n auxiliar segura
            actualizarElemento('peso-total', pesoTotal.toFixed(1));
            actualizarElemento('unidades-total', unidadesObtenidas);
            actualizarElemento('costo-mp-resumen', `$${costoMP.toFixed(2)}`);
            
            // Actualizar secci√≥n de c√°lculos
            actualizarElemento('costo-mp', `$${costoMP.toFixed(2)}`);
            actualizarElemento('costo-cif', `$${cif.toFixed(2)}`);
            actualizarElemento('costo-total', `$${costoTotalConCIF.toFixed(2)}`);
            actualizarElemento('ganancia', `$${ganancia.toFixed(2)}`);
            actualizarElemento('precio-total', `$${precioTotalPreparacion.toFixed(2)}`);
            actualizarElemento('precio-unidad', `$${precioVentaUnidad.toFixed(2)}`);
        }

        // ‚úÖ FUNCI√ìN AUXILIAR PARA ACTUALIZAR ELEMENTOS
        function actualizarElemento(id, valor) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor;
            }
        }

        // ‚úÖ FUNCI√ìN PARA COMPARACI√ìN DE PRECIOS
        function actualizarComparacionPrecio(precioReal) {
            const precio = parseFloat(precioReal) || 0;
            const comparacionDiv = document.getElementById('comparacion-precio');
            const precioCalculadoElement = document.getElementById('precio-unidad');
            
            if (!precioCalculadoElement || !comparacionDiv) return;
            
            const precioCalculado = parseFloat(precioCalculadoElement.textContent.replace('$', '')) || 0;
            
            if (precio > 0 && precioCalculado > 0) {
                const diferencia = precio - precioCalculado;
                const diferenciaPorcentaje = (diferencia / precioCalculado) * 100;
                
                let recomendacion = "Precio adecuado";
                let color = "#28a745";
                
                if (diferencia < -precioCalculado * 0.1) {
                    recomendacion = "Precio muy bajo";
                    color = "#dc3545";
                } else if (diferencia < 0) {
                    recomendacion = "Precio bajo";
                    color = "#fd7e14";
                } else if (diferencia > precioCalculado * 0.2) {
                    recomendacion = "Precio alto";
                    color = "#ffc107";
                }
                
                actualizarElemento('diferencia-precio', `Diferencia: $${diferencia.toFixed(2)} (${diferenciaPorcentaje.toFixed(1)}%)`);
                actualizarElemento('recomendacion-precio', `Recomendaci√≥n: ${recomendacion}`);
                document.getElementById('recomendacion-precio').style.color = color;
                
                comparacionDiv.style.display = 'block';
            } else {
                comparacionDiv.style.display = 'none';
            }
        }

        // ‚úÖ INICIALIZACI√ìN ROBUSTA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM completamente cargado - Sistema listo');
            
            // Event listener DIRECTO al bot√≥n (m√°s confiable)
            const botonAgregar = document.getElementById('btn-agregar-ingrediente');
            if (botonAgregar) {
                botonAgregar.addEventListener('click', agregarIngrediente);
                console.log('üéØ Event listener agregado al bot√≥n');
            }
            
            // Agregar primer ingrediente si no hay ninguno
            const container = document.getElementById('ingredientes-container');
            if (container && container.children.length === 0) {
                console.log('‚ûï Agregando primer ingrediente autom√°ticamente...');
                agregarIngrediente();
            }
            
            // Ejecutar c√°lculos iniciales
            actualizarCalculosCompletos();
            
            console.log('üéâ Inicializaci√≥n completada');
        });

        // ‚úÖ VALIDACI√ìN DEL FORMULARIO
        document.querySelector('form')?.addEventListener('submit', function(e) {
            const ingredientes = document.querySelectorAll('.ingrediente-row');
            if (ingredientes.length === 0) {
                e.preventDefault();
                alert('‚ùå Debe agregar al menos un ingrediente a la receta.');
                return false;
            }
            
            // Validaciones adicionales...
        });

        // ‚úÖ CONFIRMAR QUE LAS FUNCIONES EST√ÅN DEFINIDAS
        console.log('üîß Funciones disponibles:', {
            agregarIngrediente: typeof agregarIngrediente,
            removerIngrediente: typeof removerIngrediente,
            actualizarCalculosCompletos: typeof actualizarCalculosCompletos
        });
    </script>
</body>
</html>