<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Receta - Panader√≠a</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .btn { 
            background: #667eea; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 5px; 
            text-decoration: none; 
            border: none; 
            cursor: pointer; 
            display: inline-block;
            margin-right: 10px;
            font-size: 14px;
        }
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-remove {
            background: #dc3545;
            padding: 10px 15px;
        }
        .btn-remove:hover {
            background: #c82333;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #333;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        .ingredientes-section { 
            margin-top: 30px; 
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .ingredientes-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .ingrediente-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            align-items: end; 
        }
        .ingrediente-row select, .ingrediente-row input { 
            flex: 1; 
        }
        .navigation-links {
            margin-top: 10px;
        }
        .alert {
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .resumen-box {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üçû Crear Nueva Receta</h1>
                <div class="navigation-links">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">üè† Volver al Dashboard</a>
                    <a href="{{ url_for('recetas') }}" class="btn btn-secondary">üìã Lista de Recetas</a>
                </div>
            </div>
        </div>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST">
            <div class="form-group">
                <label>Nombre de la Receta *</label>
                <input type="text" name="nombre" required placeholder="Ej: Pan 6 Cereales y Miel">
            </div>

            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea name="descripcion" rows="3" placeholder="Descripci√≥n del producto..."></textarea>
            </div>

            <div class="form-group">
                <label>Categor√≠a *</label>
                <select name="categoria" required>
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="pan">Pan</option>
                    <option value="torta">Torta</option>
                    <option value="galleta">Galleta</option>
                    <option value="pasteleria">Pasteler√≠a</option>
                    <option value="bolleria">Boller√≠a</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label>Peso por Unidad (gramos) *</label>
                <input type="number" name="peso_unidad_gramos" step="0.01" required placeholder="350" min="1">
                <small style="color: #666; font-size: 12px;">Peso de cada unidad individual antes del horneado</small>
            </div>

            <div class="form-group">
                <label>% P√©rdida por Horneado</label>
                <input type="number" name="porcentaje_perdida" step="0.01" value="10.0" min="0" max="50" placeholder="10.0">
                <small style="color: #666; font-size: 12px;">Porcentaje de masa que se pierde durante el horneado</small>
            </div>

            <!-- SECCI√ìN DE INGREDIENTES ACTUALIZADA -->
            <div class="ingredientes-section">
                <h3>üß™ Ingredientes</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Agrega los ingredientes con sus cantidades en <strong>gramos</strong>. El sistema calcular√° autom√°ticamente los porcentajes.
                </p>
                
                <div id="ingredientes-container">
                    <!-- Los ingredientes se agregar√°n aqu√≠ din√°micamente -->
                </div>
                
                <!-- RESUMEN EN TIEMPO REAL -->
                <div class="resumen-box">
                    <strong>üìä Resumen de la f√≥rmula:</strong><br>
                    <span id="peso-total">0</span>g peso total | 
                    <span id="unidades-total">0</span> unidades obtenidas
                </div>
                
                <button type="button" onclick="agregarIngrediente()" class="btn" style="margin-top: 15px;">
                    ‚ûï Agregar Ingrediente
                </button>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <button type="submit" class="btn btn-success" style="padding: 12px 25px; font-size: 16px;">
                    üíæ Guardar Receta
                </button>
                <a href="{{ url_for('recetas') }}" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <script>
        function agregarIngrediente() {
            const container = document.getElementById('ingredientes-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'ingrediente-row';
            row.innerHTML = `
                <select name="ingredientes[${index}][materia_prima_id]" required onchange="actualizarResumen()">
                    <option value="">Seleccionar materia prima</option>
                    {% for mp in materias_primas %}
                    <option value="{{ mp.id }}">{{ mp.nombre }} ({{ mp.unidad_medida }})</option>
                    {% endfor %}
                </select>
                <input type="number" name="ingredientes[${index}][gramos]" 
                       step="0.1" placeholder="Gramos" required min="0.1" 
                       oninput="actualizarResumen()">
                <button type="button" onclick="this.parentElement.remove(); actualizarResumen();" 
                        class="btn btn-remove" title="Eliminar ingrediente">
                    ‚ùå
                </button>
            `;
            container.appendChild(row);
            actualizarResumen();
        }

        function actualizarResumen() {
            const inputs = document.querySelectorAll('input[name*="[gramos]"]');
            let pesoTotal = 0;
            
            inputs.forEach(input => {
                const valor = parseFloat(input.value) || 0;
                pesoTotal += valor;
            });
            
            // Calcular unidades obtenidas
            const pesoUnidadInput = document.querySelector('input[name="peso_unidad_gramos"]');
            const pesoUnidad = parseFloat(pesoUnidadInput?.value) || 0;
            const unidadesObtenidas = pesoUnidad > 0 ? Math.floor(pesoTotal / pesoUnidad) : 0;
            
            // Actualizar display
            document.getElementById('peso-total').textContent = pesoTotal.toFixed(1);
            document.getElementById('unidades-total').textContent = unidadesObtenidas;
            
            // Resaltar si hay suficiente masa para al menos 1 unidad
            const resumenBox = document.querySelector('.resumen-box');
            if (unidadesObtenidas > 0) {
                resumenBox.style.borderLeftColor = '#28a745';
                resumenBox.style.background = '#f8fff9';
            } else {
                resumenBox.style.borderLeftColor = '#dc3545';
                resumenBox.style.background = '#fff8f8';
            }
        }

        // Agregar un ingrediente inicial al cargar
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('ingredientes-container').children.length === 0) {
                agregarIngrediente();
            }
            
            // Actualizar resumen cuando cambie el peso por unidad
            document.querySelector('input[name="peso_unidad_gramos"]').addEventListener('input', actualizarResumen);
        });

        // Validaci√≥n mejorada del formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            const ingredientes = document.querySelectorAll('.ingrediente-row');
            if (ingredientes.length === 0) {
                e.preventDefault();
                alert('‚ùå Debe agregar al menos un ingrediente a la receta.');
                return false;
            }
            
            const pesoTotal = parseFloat(document.getElementById('peso-total').textContent) || 0;
            if (pesoTotal <= 0) {
                e.preventDefault();
                alert('‚ùå La suma total de ingredientes debe ser mayor a 0 gramos.');
                return false;
            }
            
            const pesoUnidad = parseFloat(document.querySelector('input[name="peso_unidad_gramos"]').value) || 0;
            if (pesoUnidad <= 0) {
                e.preventDefault();
                alert('‚ùå El peso por unidad debe ser mayor a 0 gramos.');
                return false;
            }
            
            const unidadesObtenidas = parseInt(document.getElementById('unidades-total').textContent) || 0;
            if (unidadesObtenidas === 0) {
                if (!confirm('‚ö†Ô∏è  El peso total de la masa no es suficiente para producir ninguna unidad. ¬øDesea continuar de todas formas?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Verificar que todos los ingredientes tengan materia prima seleccionada
            let todosValidos = true;
            ingredientes.forEach(row => {
                const select = row.querySelector('select');
                const input = row.querySelector('input[type="number"]');
                if (!select.value || !input.value || parseFloat(input.value) <= 0) {
                    todosValidos = false;
                }
            });
            
            if (!todosValidos) {
                e.preventDefault();
                alert('‚ùå Todos los ingredientes deben tener una materia prima seleccionada y una cantidad v√°lida.');
                return false;
            }
        });
    </script>
</body>
</html>