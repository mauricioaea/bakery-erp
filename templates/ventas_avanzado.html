<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Avanzado de Ventas + IA - Panader√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILOS BASE ===== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 15px;
        }
        .reporte-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1200px;
        }
        
        /* ENCABEZADO - ESTILO CIERRE CAJA */
        .reporte-header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            border-bottom: 4px solid #27ae60;
        }
        .empresa-info h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .empresa-info h4 {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        /* SELECTOR DE FECHAS */
        .selector-fechas {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 20px 30px;
        }
        
        /* M√âTRICAS PRINCIPALES - ESTILO TABLA CIERRE CAJA */
        .metricas-principales {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .tabla-metricas {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tabla-metricas td {
            padding: 15px;
            text-align: center;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .tabla-metricas .metric-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            display: block;
        }
        .tabla-metricas .metric-label {
            font-size: 0.8rem;
            color: #6c757d;
            display: block;
            margin-top: 5px;
        }
        
        /* GR√ÅFICOS COMPACTOS - CORREGIDOS */
        .seccion-graficos {
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
        }
        .grafico-compacto {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            height: 280px; /* ‚úÖ ALTURA FIJA PARA EL CONTENEDOR */
            display: flex;
            flex-direction: column;
        }
        .grafico-compacto h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
            flex-shrink: 0; /* ‚úÖ EVITA QUE EL T√çTULO SE COMPRIMA */
        }
        .grafico-container {
            flex: 1; /* ‚úÖ OCUPA EL ESPACIO RESTANTE */
            position: relative;
            min-height: 200px; /* ‚úÖ ALTURA M√çNIMA */
        }
        .grafico-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* PESTA√ëAS */
        .nav-pills .nav-link {
            color: #495057;
            font-weight: 500;
            padding: 10px 20px;
            margin: 0 2px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .nav-pills .nav-link.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
        
        /* PIE DE REPORTE */
        .reporte-footer {
            background: #f8f9fa;
            padding: 15px 30px;
            border-top: 1px solid #dee2e6;
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* ===== ESTILOS PARA RESUMEN COMPACTO ===== */
        .resumen-compacto .row > div {
            padding: 8px 5px;
        }
        .resumen-compacto strong {
            font-size: 0.9rem;
            font-weight: 700;
        }
        .resumen-compacto small {
            font-size: 0.75rem;
        }
        
        /* ===== ESTILOS OPTIMIZADOS PARA PDF ===== */
        @media print {
            .no-print { 
                display: none !important; 
            }
            body { 
                background: white !important; 
                padding: 5px !important;
                margin: 0 !important;
                font-size: 9px !important;
            }
            .reporte-container {
                box-shadow: none !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-width: 100% !important;
            }
            
            /* ENCABEZADO COMPACTO PDF */
            .reporte-header {
                padding: 10px 15px !important;
            }
            .empresa-info h1 {
                font-size: 1.2rem !important;
                margin-bottom: 2px !important;
            }
            .empresa-info h4 {
                font-size: 0.8rem !important;
                margin-bottom: 3px !important;
            }
            
            /* M√âTRICAS COMPACTAS PDF */
            .metricas-principales {
                padding: 10px 15px !important;
            }
            .tabla-metricas td {
                padding: 8px 5px !important;
            }
            .tabla-metricas .metric-valor {
                font-size: 1rem !important;
            }
            .tabla-metricas .metric-label {
                font-size: 0.65rem !important;
            }
            
            /* GR√ÅFICOS COMPACTOS PDF - MEJOR VISIBILIDAD */
            .seccion-graficos {
                padding: 10px 15px !important;
            }
            .grafico-compacto {
                padding: 8px !important;
                margin-bottom: 10px !important;
                height: 150px !important; /* ‚úÖ M√ÅS ALTO EN PDF PARA MEJOR VISIBILIDAD */
            }
            .grafico-compacto h5 {
                font-size: 0.8rem !important;
                margin-bottom: 5px !important;
            }
            .grafico-container {
                min-height: 100px !important;
            }

            /* ESTILOS ESPEC√çFICOS PARA RESUMEN COMPACTO EN PDF */
            .resumen-compacto .card-body {
                padding: 5px !important;
            }
            .resumen-compacto .row > div {
                padding: 3px 2px !important;
                border-right: 1px solid #dee2e6 !important;
            }
            .resumen-compacto .row > div:last-child {
                border-right: none !important;
            }
            .resumen-compacto strong {
                font-size: 0.7rem !important;
            }
            .resumen-compacto small {
                font-size: 0.6rem !important;
            }
            
            /* TARJETAS M√ÅS COMPACTAS EN PDF */
            .card-header {
                padding: 4px 8px !important;
            }
            .card-header h6 {
                font-size: 0.7rem !important;
                margin-bottom: 0 !important;
            }
            .card-body {
                padding: 8px !important;
            }
            .card-body p {
                font-size: 0.65rem !important;
                margin-bottom: 4px !important;
            }
            
            /* EVITAR SALTO DE P√ÅGINA */
            .no-break {
                page-break-inside: avoid;
            }
            
            /* PIE COMPACTO */
            .reporte-footer {
                padding: 8px 15px !important;
                font-size: 0.7rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="reporte-container">
        <!-- üéØ ENCABEZADO CORPORATIVO -->
        <div class="reporte-header no-break">
            <div class="row align-items-center">
                <div class="col-md-8 empresa-info">
                    <h1>PANADER√çA</h1>
                    <h4>Reporte Avanzado de Ventas con Inteligencia Artificial</h4>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-calendar-alt me-1"></i>
                            {{ fecha_inicio.strftime('%d/%m/%Y') }} - {{ fecha_fin.strftime('%d/%m/%Y') }}
                        </span>
                        <span class="badge bg-success">
                            <i class="fas fa-robot me-1"></i> AN√ÅLISIS IA ACTIVO
                        </span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-danger btn-sm no-print" onclick="generarPDF()">
                        <i class="fas fa-file-pdf me-1"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- üóìÔ∏è SELECTOR DE FECHAS (SOLO PANTALLA) -->
        <div class="selector-fechas no-print">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-calendar-alt me-2"></i> Seleccionar Per√≠odo de An√°lisis
                    </h5>
                    <form id="formFechas" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fecha_inicio" 
                                value="{{ fecha_inicio.strftime('%Y-%m-%d') if fecha_inicio else '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fecha_fin" class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="fecha_fin" 
                                value="{{ fecha_fin.strftime('%Y-%m-%d') if fecha_fin else datetime.now().strftime('%Y-%m-%d') }}" required>
                        </div>
                        <div class="col-md-3">
                            <label for="periodo" class="form-label">Per√≠odo R√°pido</label>
                            <select class="form-select" id="periodo" onchange="seleccionarPeriodoRapido()">
                                <option value="hoy">Hoy</option>
                                <option value="ayer">Ayer</option>
                                <option value="semana_actual" selected>Esta Semana</option>
                                <option value="mes_actual">Este Mes</option>
                                <option value="mes_anterior">Mes Anterior</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" onclick="actualizarReporte()">
                                <i class="fas fa-sync-alt me-1"></i> Actualizar Reporte
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- üìä M√âTRICAS PRINCIPALES - ESTILO TABLA (COMO CIERRE CAJA) -->
        <div class="metricas-principales no-break">
            <table class="tabla-metricas">
                <tr>
                    <td width="20%">
                        <span class="metric-valor">${{ "%.2f"|format(total_ventas) if total_ventas else "0.00" }}</span>
                        <span class="metric-label">TOTAL VENTAS</span>
                    </td>
                    <td width="20%">
                        <span class="metric-valor {{ 'text-success' if tendencia_ventas > 0 else 'text-danger' }}">
                            {{ "+" if tendencia_ventas > 0 }}{{ "%.1f"|format(tendencia_ventas) }}%
                        </span>
                        <span class="metric-label">TENDENCIA</span>
                    </td>
                    <td width="20%">
                        <span class="metric-valor">{{ total_transacciones }}</span>
                        <span class="metric-label">TRANSACCIONES</span>
                    </td>
                    <td width="20%">
                        <span class="metric-valor">${{ "%.0f"|format(ticket_promedio) if ticket_promedio else "0" }}</span>
                        <span class="metric-label">TICKET PROMEDIO</span>
                    </td>
                    <td width="20%">
                        <span class="metric-valor">{{ total_donaciones }}</span>
                        <span class="metric-label">DONACIONES</span>
                    </td>
                </tr>
            </table>
        </div>

        <!-- üìà SECCI√ìN DE GR√ÅFICOS COMPACTOS - CORREGIDA -->
        <div class="seccion-graficos no-break">
            <div class="row">
                <!-- GR√ÅFICO 1: TOP PRODUCTOS -->
                <div class="col-md-4">
                    <div class="grafico-compacto">
                        <h5><i class="fas fa-star me-1"></i>TOP PRODUCTOS M√ÅS VENDIDOS</h5>
                        <div class="grafico-container">
                            {% if top_productos_labels and top_productos_data %}
                                <canvas id="graficoTopProductos"></canvas>
                            {% else %}
                                <div class="text-center py-2 h-100 d-flex align-items-center justify-content-center">
                                    <div>
                                        <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-0 small">No hay datos de productos</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- GR√ÅFICO 2: DISTRIBUCI√ìN CATEGOR√çAS -->
                <div class="col-md-4">
                    <div class="grafico-compacto">
                        <h5><i class="fas fa-chart-pie me-1"></i>DISTRIBUCI√ìN POR CATEGOR√çA</h5>
                        <div class="grafico-container">
                            {% if categorias_labels and categorias_data %}
                                <canvas id="graficoCategorias"></canvas>
                            {% else %}
                                <div class="text-center py-2 h-100 d-flex align-items-center justify-content-center">
                                    <div>
                                        <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-0 small">No hay datos por categor√≠a</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- GR√ÅFICO 3: VENTAS VS DONACIONES -->
                <div class="col-md-4">
                    <div class="grafico-compacto">
                        <h5><i class="fas fa-balance-scale me-1"></i>VENTAS VS DONACIONES</h5>
                        <div class="grafico-container">
                            <canvas id="graficoVentasDonaciones"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üéØ SISTEMA DE PESTA√ëAS ORIGINAL -->
        <div class="reporte-body">
            <ul class="nav nav-pills mb-4 no-print" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" 
                            data-bs-target="#resumen" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i> Resumen Ejecutivo
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="productos-tab" data-bs-toggle="tab" 
                            data-bs-target="#productos" type="button" role="tab">
                        <i class="fas fa-boxes"></i> An√°lisis Productos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ia-tab" data-bs-toggle="tab" 
                            data-bs-target="#ia" type="button" role="tab">
                        <i class="fas fa-robot"></i> Inteligencia Artificial
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recomendaciones-tab" data-bs-toggle="tab" 
                            data-bs-target="#recomendaciones" type="button" role="tab">
                        <i class="fas fa-lightbulb"></i> Recomendaciones
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                
                <!-- üìä PESTA√ëA 1: RESUMEN EJECUTIVO -->
                <div class="tab-pane fade show active" id="resumen" role="tabpanel">
                    {% include 'secciones/resumen_ventas.html' %}
                </div>

                <!-- üì¶ PESTA√ëA 2: AN√ÅLISIS PRODUCTOS -->
                <div class="tab-pane fade" id="productos" role="tabpanel">
                    {% include 'secciones/analisis_productos.html' %}
                </div>

                <!-- ü§ñ PESTA√ëA 3: INTELIGENCIA ARTIFICIAL -->
                <div class="tab-pane fade" id="ia" role="tabpanel">
                    {% include 'secciones/analisis_ia.html' %}
                </div>

                <!-- üí° PESTA√ëA 4: RECOMENDACIONES -->
                <div class="tab-pane fade" id="recomendaciones" role="tabpanel">
                    {% include 'secciones/recomendaciones.html' %}
                </div>
            </div>
        </div>

        <!-- üìÑ PIE DE REPORTE -->
        <div class="reporte-footer text-center">
            <small>
                <i class="fas fa-sync-alt me-1"></i>
                Reporte generado el {{ datetime.now().strftime('%d/%m/%Y a las %H:%M') }} | 
                Sistema Panader√≠a con IA | Reporte Avanzado Unificado
            </small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // üéØ INICIALIZACI√ìN DE GR√ÅFICOS CORREGIDA - SOLUCI√ìN DEFINITIVA
        function inicializarGraficos() {
            // Gr√°fico Top Productos
            const ctxTopProductos = document.getElementById('graficoTopProductos');
            if (ctxTopProductos) {
                if (window.topProductosChart) {
                    window.topProductosChart.destroy();
                }
                
                window.topProductosChart = new Chart(ctxTopProductos, {
                    type: 'bar',
                    data: {
                        labels: {{ top_productos_labels|tojson }},
                        datasets: [{
                            label: 'Unidades Vendidas',
                            data: {{ top_productos_data }},
                            backgroundColor: '#3498db',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Gr√°fico de Categor√≠as
            const ctxCategorias = document.getElementById('graficoCategorias');
            if (ctxCategorias) {
                if (window.categoriasChart) {
                    window.categoriasChart.destroy();
                }
                
                window.categoriasChart = new Chart(ctxCategorias, {
                    type: 'doughnut',
                    data: {
                        labels: {{ categorias_labels|tojson }},
                        datasets: [{
                            data: {{ categorias_data }},
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    font: { 
                                        size: 10 
                                    },
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico Ventas vs Donaciones
            const ctxVentasDon = document.getElementById('graficoVentasDonaciones');
            if (ctxVentasDon) {
                if (window.ventasDonChart) {
                    window.ventasDonChart.destroy();
                }
                
                window.ventasDonChart = new Chart(ctxVentasDon, {
                    type: 'pie',
                    data: {
                        labels: ['Ventas Reales', 'Donaciones'],
                        datasets: [{
                            data: [{{ porcentaje_ventas }}, {{ porcentaje_donaciones }}],
                            backgroundColor: ['#27ae60', '#e74c3c'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    font: { 
                                        size: 10 
                                    },
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        // üóìÔ∏è FUNCIONES PARA SELECTOR DE FECHAS
        function seleccionarPeriodoRapido() {
            const periodo = document.getElementById('periodo').value;
            const hoy = new Date();
            let fechaInicio, fechaFin;

            switch(periodo) {
                case 'hoy':
                    fechaInicio = hoy;
                    fechaFin = hoy;
                    break;
                case 'ayer':
                    const ayer = new Date(hoy);
                    ayer.setDate(hoy.getDate() - 1);
                    fechaInicio = ayer;
                    fechaFin = ayer;
                    break;
                case 'semana_actual':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    fechaInicio = inicioSemana;
                    fechaFin = hoy;
                    break;
                case 'mes_actual':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    fechaFin = hoy;
                    break;
                case 'mes_anterior':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    fechaFin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    break;
                case 'personalizado':
                    return;
            }

            document.getElementById('fecha_inicio').value = fechaInicio.toISOString().split('T')[0];
            document.getElementById('fecha_fin').value = fechaFin.toISOString().split('T')[0];
        }

        function actualizarReporte() {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas');
                return;
            }

            window.location.href = `/reporte/ventas_avanzado?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
        }

        function generarPDF() {
            window.print();
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            seleccionarPeriodoRapido();
            // Peque√±o delay para asegurar que los contenedores est√©n renderizados
            setTimeout(inicializarGraficos, 100);
        });

        // Re-inicializar gr√°ficos cuando cambie el tama√±o de la ventana
        window.addEventListener('resize', function() {
            setTimeout(inicializarGraficos, 100);
        });
    </script>
</body>
</html>