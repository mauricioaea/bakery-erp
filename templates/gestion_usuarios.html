<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - Sistema Panadería</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-active { border-left: 4px solid #28a745; }
        .status-warning { border-left: 4px solid #ffc107; }
        .status-expired { border-left: 4px solid #dc3545; }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s; }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #e0a800;
        }
    </style>
</head>

<body class="bg-light">
    <!-- 🆕 SECCIÓN DE MENSAJES FLASH -->
    <div class="container-fluid mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas 
                                {% if category == 'success' %}fa-check-circle{% endif %}
                                {% if category == 'error' %}fa-exclamation-triangle{% endif %}
                                {% if category == 'warning' %}fa-exclamation-circle{% endif %}
                                me-2"></i>
                            <div class="flex-grow-1">
                                {{ message | safe }}
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-users me-2"></i>Gestión de Clientes
            </span>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
            </a>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Botón para agregar nuevo cliente -->
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCliente">
                    <i class="fas fa-plus me-2"></i>Agregar Nuevo Cliente
                </button>
            </div>
        </div>

        <!-- Tarjetas de Resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-active card-hover">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-success">{{ clientes_activos }}</h3>
                                <p class="mb-0 text-muted">Activos</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-warning card-hover">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-warning">{{ clientes_por_vencer }}</h3>
                                <p class="mb-0 text-muted">Por Vencer</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-expired card-hover">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-danger">{{ clientes_vencidos }}</h3>
                                <p class="mb-0 text-muted">Vencidos</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-times-circle fa-2x text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white card-hover">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3>{{ total_clientes }}</h3>
                                <p class="mb-0">Total Clientes</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-crown fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Clientes -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Lista de Clientes
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if configuraciones %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre de la Panadería</th>
                                        <th>Tipo de Licencia</th>
                                        <th>Límite Usuarios</th>
                                        <th>Estado</th>
                                        <th>Vencimiento</th>
                                        <th>Usuarios</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for config in configuraciones %}
                                    <tr>
                                        <td><strong>#{{ config.id }}</strong></td>
                                        <td>
                                            <div class="fw-bold">{{ config.nombre_panaderia }}</div>
                                            <small class="text-muted">{{ config.direccion or 'Sin dirección' }}</small>
                                        </td>
                                        <td>
                                            {% if config.tipo_licencia == 'local' %}
                                                <span class="badge bg-secondary">LOCAL</span>
                                            {% elif config.tipo_licencia == 'nube_basica' %}
                                                <span class="badge bg-info">NUBE BÁSICA</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">NUBE PREMIUM</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-dark">{{ config.max_usuarios }} usuarios</span>
                                        </td>
                                        <td>
                                            {% if config.tipo_licencia == 'local' %}
                                                <span class="badge bg-success">PERMANENTE</span>
                                            {% else %}
                                                <span class="badge bg-{% if config.suscripcion_activa %}success{% else %}danger{% endif %}">
                                                    {{ config.estado_suscripcion_detallado }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if config.fecha_expiracion %}
                                                {{ config.fecha_expiracion.strftime('%d/%m/%Y') }}
                                                <br>
                                                <small class="text-{% if config.dias_para_expiracion > 30 %}success{% elif config.dias_para_expiracion > 0 %}warning{% else %}danger{% endif %}">
                                                    {{ config.dias_para_expiracion }} días
                                                </small>
                                            {% else %}
                                                <em class="text-muted">No aplica</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <!-- 🆕 BOTÓN PARA VER USUARIOS -->
                                            {% if current_user.rol == 'super_admin' %}
                                            <button class="btn btn-info btn-sm" 
                                                    onclick="verUsuariosCliente({{ config.id }}, '{{ config.nombre_panaderia }}')"
                                                    title="Ver usuarios de esta panadería">
                                                <i class="fas fa-users"></i> Ver Usuarios
                                            </button>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if current_user.rol == 'super_admin' %}
                                                <button class="btn btn-outline-primary" 
                                                        onclick="editarCliente({{ config.id }})"
                                                        title="Editar Cliente">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-success"
                                                        onclick="renovarSuscripcion({{ config.id }})"
                                                        title="Renovar Suscripción">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-warning"
                                                        onclick="accederPanaderia({{ config.id }}, '{{ config.nombre_panaderia }}')"
                                                        title="Acceder a esta panadería">
                                                    <i class="fas fa-sign-in-alt"></i>
                                                </button>
                                                {% else %}
                                                <span class="text-muted">Solo super_admin</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No hay clientes registrados</h4>
                            <p class="text-muted">Comienza agregando tu primer cliente usando el botón superior.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-plus me-2"></i>Agregar Nuevo Cliente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formCliente" method="POST" action="{{ url_for('crear_cliente') }}">
                    <div class="modal-body">
                        <!-- Información Básica -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre de la Panadería *</label>
                                <input type="text" class="form-control" name="nombre_panaderia" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono de Contacto</label>
                                <input type="text" class="form-control" name="telefono_contacto">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Dirección</label>
                                <textarea class="form-control" name="direccion" rows="2"></textarea>
                            </div>
                        </div>

                        <!-- Tipo de Licencia -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Licencia *</label>
                                <select class="form-select" name="tipo_licencia" id="tipoLicencia" required onchange="toggleFechaExpiracion()">
                                    <option value="local">Local (Permanente)</option>
                                    <option value="nube_basica">Nube Básica</option>
                                    <option value="nube_premium">Nube Premium</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Límite de Usuarios *</label>
                                <input type="number" class="form-control" name="max_usuarios" value="3" min="1" max="50" required>
                            </div>
                        </div>

                        <!-- Fecha de Expiración (solo para nube) -->
                        <div class="row mb-3" id="fechaExpiracionGroup" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label">Fecha de Expiración *</label>
                                <input type="date" class="form-control" name="fecha_expiracion" id="fechaExpiracion">
                                <div class="form-text">Para licencias en la nube, define la fecha de vencimiento</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Días de Gracia</label>
                                <input type="number" class="form-control" name="dias_gracia" value="7" min="0" max="30">
                                <div class="form-text">Días adicionales después del vencimiento</div>
                            </div>
                        </div>

                        <!-- Información de Facturación -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Razón Social</label>
                                <input type="text" class="form-control" name="razon_social">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">NIT</label>
                                <input type="text" class="form-control" name="nit">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 🆕 MODAL PARA VER USUARIOS DEL CLIENTE -->
    <div class="modal fade" id="usuariosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="usuariosModalTitle">
                        <i class="fas fa-users me-2"></i>Usuarios de la Panadería
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="usuariosContent">
                        <!-- Aquí se cargarán los usuarios dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleFechaExpiracion() {
            const tipoLicencia = document.getElementById('tipoLicencia').value;
            const fechaGroup = document.getElementById('fechaExpiracionGroup');
            const fechaInput = document.getElementById('fechaExpiracion');
            
            if (tipoLicencia === 'local') {
                fechaGroup.style.display = 'none';
                fechaInput.removeAttribute('required');
            } else {
                fechaGroup.style.display = 'flex';
                fechaInput.setAttribute('required', 'required');
                
                // Establecer fecha por defecto (30 días desde hoy)
                const hoy = new Date();
                const fechaFutura = new Date(hoy);
                fechaFutura.setDate(hoy.getDate() + 30);
                fechaInput.value = fechaFutura.toISOString().split('T')[0];
            }
        }

        // 🆕 FUNCIÓN PARA VER USUARIOS DEL CLIENTE
        async function verUsuariosCliente(panaderiaId, nombrePanaderia) {
            try {
                const response = await fetch(`/obtener_usuarios_panaderia/${panaderiaId}`);
                const usuarios = await response.json();
                
                let html = `<h6 class="mb-3">Usuarios de: <strong>${nombrePanaderia}</strong></h6>`;
                
                if (usuarios.length > 0) {
                    html += `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    usuarios.forEach(usuario => {
                        html += `
                        <tr>
                            <td>
                                <i class="fas fa-user me-1"></i>
                                <strong>${usuario.username}</strong>
                                <br><small class="text-muted">${usuario.nombre_completo}</small>
                            </td>
                            <td>
                                <span class="badge ${usuario.rol === 'admin_cliente' ? 'bg-danger' : usuario.rol === 'supervisor' ? 'bg-info' : 'bg-secondary'}">
                                    ${usuario.rol}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${usuario.activo ? 'bg-success' : 'bg-danger'}">
                                    ${usuario.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm" 
                                        onclick="resetearPasswordUsuario(${usuario.id}, '${usuario.username}')"
                                        title="Resetear contraseña">
                                    <i class="fas fa-key"></i> Resetear
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    </div>
                    `;
                } else {
                    html += '<div class="alert alert-warning">No hay usuarios registrados para esta panadería.</div>';
                }
                
                document.getElementById('usuariosContent').innerHTML = html;
                document.getElementById('usuariosModalTitle').innerHTML = `<i class="fas fa-users me-2"></i>Usuarios de: ${nombrePanaderia}`;
                
                const modal = new bootstrap.Modal(document.getElementById('usuariosModal'));
                modal.show();
                
            } catch (error) {
                alert('Error al cargar usuarios: ' + error);
            }
        }

        // 🆕 FUNCIÓN PARA RESETEAR CONTRASEÑA DESDE GESTIÓN DE CLIENTES
        async function resetearPasswordUsuario(usuarioId, usuarioNombre) {
            if (!confirm(`¿Resetear contraseña de ${usuarioNombre}?`)) return;
            
            try {
                const response = await fetch(`/resetear_password/${usuarioId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Contraseña reseteada para ${usuarioNombre}\n\nNueva contraseña: ${result.nueva_password}\n\n¡Cópiala ahora!`);
                } else {
                    alert('❌ Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        // 🆕 FUNCIÓN PARA ACCEDER A PANADERÍA
        function accederPanaderia(panaderiaId, nombrePanaderia) {
            if (confirm(`¿Acceder a la panadería "${nombrePanaderia}"?`)) {
                // Esta función se implementará después
                alert('🔧 Función en desarrollo - Próximamente podrás acceder a cualquier panadería');
            }
        }

        function editarCliente(id) {
            alert('🔧 Editar cliente: ' + id + ' - Función en desarrollo');
        }

        function renovarSuscripcion(id) {
            alert('🔧 Renovar suscripción: ' + id + ' - Función en desarrollo');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            toggleFechaExpiracion();
        });
    </script>
</body>
</html>