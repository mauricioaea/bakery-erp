<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos Externos - Panader√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stock-bajo {
            background-color: #ffe6e6;
        }
        .stock-ok {
            background-color: #e6ffe6;
        }
    </style>
</head>
<body>
    <!-- Barra de navegaci√≥n (usar la misma que en otros templates) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">üçû Panader√≠a</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/punto_venta">Punto de Venta</a>
                <a class="nav-link" href="/productos_externos">Productos Externos</a>
                <a class="nav-link" href="/proveedores">Proveedores</a>
                <span class="navbar-text me-3">Hola, {{ session.username }}</span>
                <a class="btn btn-outline-light btn-sm" href="/logout">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>üçπ Productos Externos</h2>
        <p class="text-muted">Gesti√≥n de bebidas, helados y otros productos externos</p>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Formulario para agregar producto -->
       
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">‚ûï Agregar Nuevo Producto</h5>
            </div>
            <div class="card-body">
                <form id="formProductoExterno" onsubmit="agregarProducto(event)">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" name="nombre" class="form-control" placeholder="Ej: Jugo Hit" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Categor√≠a *</label>
                            <select name="categoria" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Helados">Helados</option>
                                <option value="Snacks">Snacks</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Marca</label>
                            <input type="text" name="marca" class="form-control" placeholder="Ej: Coca-Cola">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Compra *</label>
                            <input type="number" name="precio_compra" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Venta *</label>
                            <input type="number" name="precio_venta" class="form-control" step="0.01" min="0" required>
                        </div>
                        
                        <!-- SEGUNDA FILA DE CAMPOS -->
                        <div class="col-md-3">
                            <label class="form-label">Proveedor</label>
                            <select name="proveedor_id" class="form-control">
                                <option value="">Sin proveedor</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" name="codigo_barras" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" name="descripcion" class="form-control" placeholder="Descripci√≥n breve">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Stock M√≠nimo</label>
                            <input type="number" name="stock_minimo" class="form-control" value="5" min="1">
                        </div>
                    </div>
                    
                    <!-- ‚úÖ BOT√ìN DENTRO DEL FORMULARIO -->
                    <div class="mt-3 sticky-bottom">
                        <div class="bg-light p-3 border-top">
                            <button type="submit" class="btn btn-success w-100 py-2">
                                ‚ûï Agregar Producto al Inventario
                            </button>
                        </div>
                    </div>
        </button>
    </div>
</div>
                </form>
            </div>
        </div>


        <!-- Lista de productos -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üì¶ Inventario de Productos Externos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Marca</th>
                                <th>Stock</th>
                                <th>P. Compra</th>
                                <th>P. Venta</th>
                                <th>Utilidad</th>
                                <th>Margen</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr class="{% if producto.stock_actual <= producto.stock_minimo %}table-warning{% endif %}">
                                <td>
                                    <strong>{{ producto.nombre }}</strong>
                                    {% if producto.descripcion %}
                                    <br><small class="text-muted">{{ producto.descripcion }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ producto.categoria }}</span>
                                </td>
                                <td>{{ producto.marca or '-' }}</td>
                                <td>
                                    <span class="badge {% if producto.stock_actual <= producto.stock_minimo %}bg-danger{% else %}bg-success{% endif %}">
                                        {{ producto.stock_actual }}
                                    </span>
                                    {% if producto.stock_actual <= producto.stock_minimo %}
                                    <br><small class="text-danger">Stock bajo</small>
                                    {% endif %}
                                </td>
                                <td>${{ "{:,.0f}".format(producto.precio_compra) }}</td>
                                <td>${{ "{:,.0f}".format(producto.precio_venta) }}</td>
                                <td>
                                    <span class="text-success fw-bold">
                                        ${{ "{:,.0f}".format(producto.utilidad_unitaria) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        {{ "%.1f"|format(producto.margen_ganancia) }}%
                                    </span>
                                </td>
                                <td>
                                    {% if producto.proveedor %}
                                    {{ producto.proveedor.nombre }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="abrirModalCompra({{ producto.id }})" 
                                                title="Registrar compra">
                                            üõí
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editarProducto({{ producto.id }})" 
                                                title="Editar producto">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="eliminarProducto({{ producto.id }})" 
                                                title="Eliminar producto">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    No hay productos externos registrados. Agrega el primero usando el formulario arriba.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para registrar compra -->
    <div class="modal fade" id="modalCompra" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üõí Registrar Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCompraExterna">
                        <input type="hidden" id="compra_producto_id" name="producto_id">
                        <div class="mb-3">
                            <label class="form-label">Producto</label>
                            <input type="text" id="compra_producto_nombre" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proveedor *</label>
                            <select name="proveedor_id" class="form-control" required>
                                <option value="">Seleccionar proveedor</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Cantidad *</label>
                                <input type="number" name="cantidad" class="form-control" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Precio Compra *</label>
                                <input type="number" name="precio_compra" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas (opcional)</label>
                            <textarea name="notas" class="form-control" rows="2" placeholder="Observaciones de la compra..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="registrarCompra()">Registrar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funciones JavaScript para interactuar con el backend
        async function agregarProducto(event) {
            event.preventDefault();
            console.log('üìù Iniciando agregar producto...');
            
            const formData = new FormData(event.target);
            console.log('üì¶ Datos del formulario:', Object.fromEntries(formData));
            
            try {
                const response = await fetch('/agregar_producto_externo', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('üì° Respuesta del servidor:', response.status);
                const result = await response.json();
                console.log('üìä Resultado:', result);
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    console.log('üîÑ Recargando p√°gina...');
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + result.message);
                }
            } catch (error) {
                console.error('üí• Error:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        function abrirModalCompra(productoId) {
            // Buscar el producto en la lista de productos
            let productoEncontrado = null;
            
            // Convertir los productos de Jinja2 a un array JavaScript
            const productos = [
                {% for p in productos %}
                {
                    id: {{ p.id }},
                    nombre: "{{ p.nombre }}",
                    precio_compra: {{ p.precio_compra }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            
            // Encontrar el producto por ID
            productoEncontrado = productos.find(p => p.id === productoId);
            
            if (productoEncontrado) {
                document.getElementById('compra_producto_id').value = productoEncontrado.id;
                document.getElementById('compra_producto_nombre').value = productoEncontrado.nombre;
                document.querySelector('input[name="precio_compra"]').value = productoEncontrado.precio_compra;
                
                const modal = new bootstrap.Modal(document.getElementById('modalCompra'));
                modal.show();
            } else {
                alert('‚ùå Producto no encontrado');
            }
        }

        async function registrarCompra() {
            const formData = new FormData(document.getElementById('formCompraExterna'));
            
            try {
                const response = await fetch('/registrar_compra_externa', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        function eliminarProducto(productoId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                window.location.href = '/eliminar_producto_externo/' + productoId;
            }
        }

        function editarProducto(productoId) {
            // Implementar edici√≥n (similar a agregar pero con datos precargados)
            alert('Funci√≥n de edici√≥n para producto ID: ' + productoId);
            // Puedes implementar un modal similar al de compra para editar
        }
    </script>
</body>
</html>