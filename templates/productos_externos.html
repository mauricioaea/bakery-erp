<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos Externos - Panader√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stock-bajo {
            background-color: #ffe6e6;
        }
        .stock-ok {
            background-color: #e6ffe6;
        }
    </style>
</head>
<body>
    <!-- Barra de navegaci√≥n (usar la misma que en otros templates) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">üçû Panader√≠a</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/punto_venta">Punto de Venta</a>
                <a class="nav-link" href="/productos_externos">Productos Externos</a>
                
                <!-- AGREGAR AQU√ç EL DROPDOWN DE REPORTES -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="reportesDropdown" role="button" data-bs-toggle="dropdown">
                        üìä Reportes
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/reporte_inventario_externo">üì¶ Inventario Externo</a></li>
                        <li><a class="dropdown-item" href="/reporte_ventas_externas">üí∞ Ventas Externas</a></li>
                        <li><a class="dropdown-item" href="/dashboard_externos">üìà Dashboard Externo</a></li>
                    </ul>
                </div>
                <!-- FIN DEL DROPDOWN -->
                
                <a class="nav-link" href="/proveedores">Proveedores</a>
                <span class="navbar-text me-3">Hola, {{ session.username }}</span>
                <a class="btn btn-outline-light btn-sm" href="/logout">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>üçπ Productos Externos</h2>
        <p class="text-muted">Gesti√≥n de bebidas, helados y otros productos externos</p>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Formulario para agregar producto -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">‚ûï Agregar Nuevo Producto</h5>
            </div>
            <div class="card-body">
                <!-- CAMBIO: action y method correctos -->
                <form action="/crear_producto_externo" method="POST" id="formProductoExterno">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" name="nombre" class="form-control" placeholder="Ej: Jugo Hit" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Categor√≠a *</label>
                            <select name="categoria" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Helados">Helados</option>
                                <option value="Snacks">Snacks</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Marca</label>
                            <input type="text" name="marca" class="form-control" placeholder="Ej: Coca-Cola">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Compra *</label>
                            <input type="number" name="precio_compra" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Venta *</label>
                            <input type="number" name="precio_venta" class="form-control" step="0.01" min="0" required>
                        </div>
                        
                        <!-- SEGUNDA FILA DE CAMPOS -->
                        <div class="col-md-3">
                            <label class="form-label">Proveedor</label>
                            <select name="proveedor_id" class="form-control">
                                <option value="">Sin proveedor</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" name="codigo_barras" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" name="descripcion" class="form-control" placeholder="Descripci√≥n breve">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Stock Actual</label>
                            <input type="number" name="stock_actual" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Stock M√≠nimo</label>
                            <input type="number" name="stock_minimo" class="form-control" value="5" min="1">
                        </div>
                    </div>
                    
                    <!-- ‚úÖ BOT√ìN DENTRO DEL FORMULARIO -->
                    <div class="mt-3 sticky-bottom">
                        <div class="bg-light p-3 border-top">
                            <button type="submit" class="btn btn-success w-100 py-2">
                                ‚ûï Agregar Producto al Inventario
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de productos -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üì¶ Inventario de Productos Externos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Marca</th>
                                <th>Stock</th>
                                <th>P. Compra</th>
                                <th>P. Venta</th>
                                <th>Utilidad</th>
                                <th>Margen</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr class="{% if producto.stock_actual <= producto.stock_minimo %}table-warning{% endif %}">
                                <td>
                                    <strong>{{ producto.nombre }}</strong>
                                    {% if producto.descripcion %}
                                    <br><small class="text-muted">{{ producto.descripcion }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ producto.categoria }}</span>
                                </td>
                                <td>{{ producto.marca or '-' }}</td>
                                <td>
                                    <span class="badge {% if producto.stock_actual <= producto.stock_minimo %}bg-danger{% else %}bg-success{% endif %}">
                                        {{ producto.stock_actual }}
                                    </span>
                                    {% if producto.stock_actual <= producto.stock_minimo %}
                                    <br><small class="text-danger">Stock bajo</small>
                                    {% endif %}
                                </td>
                                <td>${{ "{:,.0f}".format(producto.precio_compra) }}</td>
                                <td>${{ "{:,.0f}".format(producto.precio_venta) }}</td>
                                <td>
                                    <span class="text-success fw-bold">
                                        ${{ "{:,.0f}".format(producto.utilidad_unitaria) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        {{ "%.1f"|format(producto.margen_ganancia) }}%
                                    </span>
                                </td>
                                <td>
                                    {% if producto.proveedor %}
                                    {{ producto.proveedor.nombre }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="abrirModalCompra({{ producto.id }})" 
                                                title="Registrar compra">
                                            üõí
                                        </button>
                                        <!-- CAMBIO: Ahora abre modal de edici√≥n -->
                                        <button class="btn btn-outline-warning" onclick="abrirModalEdicion({{ producto.id }})" 
                                                title="Editar producto">
                                            ‚úèÔ∏è
                                        </button>
                                        <!-- CAMBIO: Ahora usa POST para eliminar -->
                                        <form action="/eliminar_producto_externo/{{ producto.id }}" method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-danger" 
                                                    onclick="return confirm('¬øEst√°s seguro de eliminar este producto?')"
                                                    title="Eliminar producto">
                                                üóëÔ∏è
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    No hay productos externos registrados. Agrega el primero usando el formulario arriba.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para registrar compra -->
    <div class="modal fade" id="modalCompra" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üõí Registrar Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCompraExterna">
                        <input type="hidden" id="compra_producto_id" name="producto_id">
                        <div class="mb-3">
                            <label class="form-label">Producto</label>
                            <input type="text" id="compra_producto_nombre" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proveedor *</label>
                            <select name="proveedor_id" class="form-control" required>
                                <option value="">Seleccionar proveedor</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Cantidad *</label>
                                <input type="number" name="cantidad" class="form-control" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Precio Compra *</label>
                                <input type="number" name="precio_compra" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas (opcional)</label>
                            <textarea name="notas" class="form-control" rows="2" placeholder="Observaciones de la compra..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="registrarCompra()">Registrar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal para editar producto -->
    <div class="modal fade" id="modalEdicion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEdicionProducto" method="POST">
                        <input type="hidden" id="editar_producto_id" name="producto_id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" id="editar_nombre" name="nombre" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Categor√≠a *</label>
                                <select id="editar_categoria" name="categoria" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Bebidas">Bebidas</option>
                                    <option value="Helados">Helados</option>
                                    <option value="Snacks">Snacks</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Marca</label>
                                <input type="text" id="editar_marca" name="marca" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">C√≥digo de Barras</label>
                                <input type="text" id="editar_codigo_barras" name="codigo_barras" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea id="editar_descripcion" name="descripcion" class="form-control" rows="2"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Precio Compra *</label>
                                <input type="number" id="editar_precio_compra" name="precio_compra" class="form-control" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Precio Venta *</label>
                                <input type="number" id="editar_precio_venta" name="precio_venta" class="form-control" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stock Actual</label>
                                <input type="number" id="editar_stock_actual" name="stock_actual" class="form-control" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Stock M√≠nimo</label>
                                <input type="number" id="editar_stock_minimo" name="stock_minimo" class="form-control" min="1" value="5">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Proveedor</label>
                                <select id="editar_proveedor_id" name="proveedor_id" class="form-control">
                                    <option value="">Sin proveedor</option>
                                    {% for proveedor in proveedores %}
                                    <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Datos de productos para JavaScript
        const productos = [
            {% for p in productos %}
            {
                id: {{ p.id }},
                nombre: "{{ p.nombre }}",
                descripcion: "{{ p.descripcion or '' }}",
                categoria: "{{ p.categoria }}",
                marca: "{{ p.marca or '' }}",
                codigo_barras: "{{ p.codigo_barras or '' }}",
                precio_compra: {{ p.precio_compra }},
                precio_venta: {{ p.precio_venta }},
                stock_actual: {{ p.stock_actual }},
                stock_minimo: {{ p.stock_minimo }},
                proveedor_id: {{ p.proveedor_id or 'null' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function abrirModalCompra(productoId) {
            const producto = productos.find(p => p.id === productoId);
            if (producto) {
                document.getElementById('compra_producto_id').value = producto.id;
                document.getElementById('compra_producto_nombre').value = producto.nombre;
                document.querySelector('#formCompraExterna input[name="precio_compra"]').value = producto.precio_compra;
                
                const modal = new bootstrap.Modal(document.getElementById('modalCompra'));
                modal.show();
            } else {
                alert('‚ùå Producto no encontrado');
            }
        }

        // NUEVA FUNCI√ìN: Abrir modal de edici√≥n
        function abrirModalEdicion(productoId) {
            const producto = productos.find(p => p.id === productoId);
            if (producto) {
                // Llenar el formulario con los datos del producto
                document.getElementById('editar_producto_id').value = producto.id;
                document.getElementById('editar_nombre').value = producto.nombre;
                document.getElementById('editar_descripcion').value = producto.descripcion;
                document.getElementById('editar_categoria').value = producto.categoria;
                document.getElementById('editar_marca').value = producto.marca;
                document.getElementById('editar_codigo_barras').value = producto.codigo_barras;
                document.getElementById('editar_precio_compra').value = producto.precio_compra;
                document.getElementById('editar_precio_venta').value = producto.precio_venta;
                document.getElementById('editar_stock_actual').value = producto.stock_actual;
                document.getElementById('editar_stock_minimo').value = producto.stock_minimo;
                document.getElementById('editar_proveedor_id').value = producto.proveedor_id || '';
                
                const modal = new bootstrap.Modal(document.getElementById('modalEdicion'));
                modal.show();
            } else {
                alert('‚ùå Producto no encontrado');
            }
        }

        // NUEVA FUNCI√ìN: Guardar edici√≥n
        async function guardarEdicion() {
            const form = document.getElementById('formEdicionProducto');
            const formData = new FormData(form);
            const productoId = document.getElementById('editar_producto_id').value;
            
            try {
                const response = await fetch(`/editar_producto_externo/${productoId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('‚úÖ Producto actualizado exitosamente');
                    window.location.reload();
                } else {
                    alert('‚ùå Error al actualizar el producto');
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function registrarCompra() {
            const formData = new FormData(document.getElementById('formCompraExterna'));
            
            try {
                const response = await fetch('/registrar_compra_externa', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }
    </script>
</body>
</html>